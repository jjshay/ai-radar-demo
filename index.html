<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>AI Radar Mobile</title>
  <style>
    /* CSS Variables - Dark theme with gold accents */
    :root {
      --bg-primary: #0a1628;
      --bg-secondary: #111d32;
      --bg-card: #1a2a44;
      --gold: #D4AF37;
      --gold-light: #f4d785;
      --gold-dark: #a08520;
      --text: #ffffff;
      --text-muted: #8a9bb3;
      --green: #4ade80;
      --red: #ef4444;
      --blue: #3b82f6;
      --purple: #a855f7;

      /* AI Model Colors */
      --ai-gpt: #10a37f;
      --ai-claude: #d97706;
      --ai-gemini: #4285f4;
      --ai-grok: #ffffff;
      --ai-pplx: #8b5cf6;

      --linkedin-blue: #0A66C2;

      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text);
    }

    /* Screen Container */
    .app {
      height: 100%;
      width: 100%;
      position: relative;
      overflow: hidden;
    }

    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      flex-direction: column;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }

    .screen.active {
      display: flex;
    }

    /* ============================================
       SCREEN 1: HOME
       ============================================ */
    #screen-home {
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .logo-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 50px;
    }

    .logo-icon {
      width: 160px;
      height: 160px;
      flex-shrink: 0;
    }

    .logo-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .logo-tagline {
      font-size: 16px;
      color: white;
      letter-spacing: 1px;
      text-align: center;
    }

    /* Topic Selector */
    .topic-selector {
      width: 100%;
      max-width: 320px;
      margin-bottom: 20px;
    }

    .topic-selector label {
      display: block;
      font-size: 12px;
      color: white;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .topic-selector select {
      width: 100%;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 16px;
      color: #1e3a5f;
      font-size: 16px;
      font-family: inherit;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%231e3a5f' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
      cursor: pointer;
    }

    .topic-selector select:focus {
      outline: none;
      border-color: var(--gold);
    }

    .topic-selector select option {
      background: white;
      color: #1a1a1a;
      padding: 10px;
    }

    .topic-selector select optgroup {
      color: var(--gold);
      font-weight: 600;
    }

    /* Favorites Button */
    .favorites-btn {
      width: 100%;
      max-width: 320px;
      padding: 16px;
      background: var(--bg-secondary);
      border: 2px solid var(--bg-card);
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .favorites-btn .badge {
      background: var(--red);
      color: white;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
    }

    /* ============================================
       SCREEN 2: SWIPE CARDS
       ============================================ */
    #screen-swipe {
      background: var(--bg-primary);
    }

    .swipe-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.1);
    }

    .swipe-card-counter {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
    }

    .swipe-card-counter span {
      color: var(--gold);
    }

    .back-btn {
      background: none;
      border: none;
      color: #1e3a5f;
      font-size: 18px;
      cursor: pointer;
      padding: 10px;
      margin: -10px;
    }

    .article-count {
      font-size: 14px;
      color: #1e3a5f;
    }

    /* Card Stack */
    .card-stack {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }

    .swipe-card {
      position: absolute;
      width: calc(100% - 40px);
      max-width: 340px;
      height: auto;
      max-height: 420px;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      touch-action: none;
      user-select: none;
      transition: box-shadow 0.2s, transform 0.3s ease;
    }

    .swipe-card:hover {
      box-shadow: 0 8px 30px rgba(0,0,0,0.25), 0 0 20px rgba(212, 175, 55, 0.4);
    }

    .swipe-card.dragging {
      transition: none;
    }

    .swipe-card .card-image {
      width: 100%;
      height: 100px;
      background-color: var(--bg-secondary);
      background-size: cover;
      background-position: center;
      position: relative;
      flex-shrink: 0;
    }

    .swipe-card .card-image.logo-fallback {
      background-size: 60px 60px;
      background-repeat: no-repeat;
      background-position: center;
    }

    .swipe-card .card-image::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(transparent, white);
    }

    .swipe-card .card-body {
      padding: 12px 14px;
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .swipe-card .card-source {
      display: inline-block;
      background: #f0f0f0;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 10px;
      color: #666;
      margin-bottom: 6px;
      align-self: flex-start;
    }

    .swipe-card .card-title {
      font-size: 14px;
      font-weight: 700;
      line-height: 1.3;
      margin-bottom: 6px;
      color: #1a1a1a;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .swipe-card .card-summary {
      font-size: 11px;
      color: #666;
      line-height: 1.4;
      margin-bottom: 6px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .swipe-card .card-topics {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px;
    }

    .swipe-card .card-topic {
      background: linear-gradient(135deg, var(--gold-light), var(--gold));
      color: #1a1a1a;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: 600;
    }

    .swipe-card .card-meta {
      display: flex;
      gap: 12px;
      font-size: 11px;
      color: #666;
      margin-bottom: 10px;
    }

    .swipe-card .card-meta span {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .swipe-card .card-score {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .swipe-card .score-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--gold);
    }

    .swipe-card .score-label {
      font-size: 10px;
      color: var(--text-muted);
    }

    /* AI Scores Section */
    .ai-scores-section {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 8px;
      margin-top: auto;
    }

    .ai-score-item:active {
      transform: scale(0.95);
    }

    /* Sentiment Badges */
    .sentiment-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 6px;
    }
    .sentiment-badge.positive { background: rgba(34,197,94,0.15); color: #22c55e; }
    .sentiment-badge.negative { background: rgba(239,68,68,0.15); color: #ef4444; }
    .sentiment-badge.neutral { background: rgba(156,163,175,0.15); color: #9ca3af; }
    .sentiment-badge.mixed { background: rgba(234,179,8,0.15); color: #eab308; }

    /* Article Tags */
    .article-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 6px; }
    .article-tag {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 8px;
      font-size: 8px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: #fff;
    }
    .article-tag.trending { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .article-tag.hot { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .article-tag.top-article { background: linear-gradient(135deg, #D4AF37, #a08520); }
    .article-tag.breaking { background: linear-gradient(135deg, #8b5cf6, #7c3aed); animation: breakingPulse 2s ease-in-out infinite; }
    .article-tag.viral { background: linear-gradient(135deg, #06b6d4, #0891b2); }
    .article-tag.must-read { background: linear-gradient(135deg, #10b981, #059669); }
    .article-tag.deep-dive { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .article-tag.game-changer { background: linear-gradient(135deg, #D4AF37, #f59e0b); animation: breakingPulse 2s ease-in-out infinite; }
    @keyframes breakingPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

    /* Home Button */
    .home-btn {
      margin: 8px auto 0;
      display: block;
      background: transparent;
      border: 1px solid rgba(212,175,55,0.3);
      color: var(--gold);
      padding: 8px 24px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }
    .home-btn:active { background: rgba(212,175,55,0.15); border-color: var(--gold); }

    /* Abort Button */
    .abort-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #999;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, color 0.2s;
      z-index: 10;
    }
    .abort-btn:active { background: rgba(255,0,0,0.2); color: #ef4444; }

    /* Audio Stop Button */
    .audio-stop-btn {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.3);
      color: #ef4444;
      padding: 6px 14px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .audio-stop-btn:active { background: rgba(239,68,68,0.3); }

    /* AI Detail Popup */
    .ai-detail-popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .ai-detail-content {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      max-width: 320px;
      width: 100%;
    }

    .ai-detail-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .ai-detail-rationale {
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .ai-detail-close {
      width: 100%;
      padding: 12px;
      background: var(--gold);
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--bg-primary);
      cursor: pointer;
    }

    .ai-scores-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .ai-scores-header .avg-score {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold);
    }

    .ai-scores-header .avg-label {
      font-size: 10px;
      color: var(--text-muted);
    }

    .ai-rationales {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 120px;
      overflow-y: auto;
    }

    .ai-rationale {
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    .ai-rationale .ai-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .ai-rationale .ai-icon.gpt { background: var(--ai-gpt); color: white; }
    .ai-rationale .ai-icon.claude { background: var(--ai-claude); color: white; }
    .ai-rationale .ai-icon.gemini { background: var(--ai-gemini); color: white; }
    .ai-rationale .ai-icon.grok { background: var(--ai-grok); color: var(--bg-primary); }
    .ai-rationale .ai-icon.pplx { background: var(--ai-pplx); color: white; }

    .ai-rationale .rationale-text {
      font-size: 10px;
      color: #666;
      line-height: 1.3;
    }

    .ai-rationale .rationale-score {
      font-weight: 600;
      color: #333;
    }

    /* Legacy badge styles for other screens */
    .ai-scores-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .ai-badge {
      display: flex;
      align-items: center;
      gap: 2px;
      background: var(--bg-secondary);
      padding: 4px 6px;
      border-radius: 12px;
      font-size: 10px;
    }

    .ai-badge .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .ai-badge.gpt .dot { background: var(--ai-gpt); }
    .ai-badge.claude .dot { background: var(--ai-claude); }
    .ai-badge.gemini .dot { background: var(--ai-gemini); }
    .ai-badge.grok .dot { background: var(--ai-grok); }
    .ai-badge.pplx .dot { background: var(--ai-pplx); }

    /* Swipe Indicators */
    .swipe-indicator {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 48px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .swipe-indicator.left { left: 30px; }
    .swipe-indicator.right { right: 30px; }
    .swipe-indicator.up { top: 30px; left: 50%; transform: translateX(-50%); }
    .swipe-indicator.down { bottom: 30px; top: auto; left: 50%; transform: translateX(-50%); }

    /* Swipe Hints */
    .swipe-hints {
      padding: 20px;
      display: flex;
      justify-content: space-around;
      background: var(--bg-secondary);
    }

    .hint {
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
    }

    .hint .arrow {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .hint.hot .arrow { color: var(--green); }
    .hint.not .arrow { color: var(--red); }
    .hint.delete .arrow { color: var(--text-muted); }
    .hint.post .arrow { color: var(--gold); }

    /* ============================================
       SCREEN 5: FAVORITES
       ============================================ */
    #screen-favorites {
      background: var(--bg-primary);
    }

    .favorites-header {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      background: var(--bg-secondary);
      gap: 10px;
    }

    .favorites-header h1 {
      flex: 1;
      font-size: 16px;
      margin: 0;
    }

    .favorites-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .favorites-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .favorites-empty .icon {
      font-size: 40px;
      margin-bottom: 10px;
      opacity: 0.3;
    }

    .favorite-item {
      background: white;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 8px;
      position: relative;
    }

    .favorite-item .delete-x {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .favorite-item .fav-source {
      display: inline-block;
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 9px;
      color: #666;
      margin-bottom: 4px;
    }

    .favorite-item .fav-title {
      font-size: 12px;
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 4px;
      color: #1a1a1a;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .favorite-item .fav-topics {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      margin-bottom: 6px;
    }

    .favorite-item .fav-topic {
      background: linear-gradient(135deg, var(--gold-light), var(--gold));
      color: #1a1a1a;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 8px;
      font-weight: 600;
    }

    .favorite-item .fav-meta {
      display: flex;
      gap: 10px;
      font-size: 10px;
      color: #666;
      margin-bottom: 6px;
    }

    .favorite-item .fav-scores {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .favorite-item .fav-avg {
      font-size: 14px;
      font-weight: 700;
      color: var(--gold);
    }

    .favorite-item .fav-logos {
      display: flex;
      gap: 4px;
    }

    .favorite-item .fav-logos img {
      width: 16px;
      height: 16px;
      border-radius: 50%;
    }

    .favorite-item .fav-expanded {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e0e0e0;
    }

    .favorite-item .fav-description {
      font-size: 11px;
      color: #555;
      line-height: 1.4;
      margin-bottom: 10px;
    }

    .favorite-item .fav-create-btn {
      width: 100%;
      padding: 10px;
      background: var(--gold);
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      color: var(--bg-primary);
      cursor: pointer;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 22, 40, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .loading-overlay.show {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--bg-card);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-card);
      padding: 15px 25px;
      border-radius: 30px;
      font-size: 14px;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 200;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* ============================================
       SCREEN 5: RESULTS
       ============================================ */
    #screen-results {
      background: var(--bg-primary);
      padding: 30px 20px;
    }

    .results-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .results-header h1 {
      font-size: 28px;
      margin-bottom: 8px;
      color: white;
    }

    .results-subtitle {
      color: var(--text-muted);
      font-size: 14px;
    }

    /* Source Info Bar */
    .results-source-info {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 12px 15px;
      margin-bottom: 20px;
    }

    .results-source-info .source-logo {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: contain;
      background: white;
      padding: 4px;
    }

    .results-source-info .source-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .results-source-info .source-name {
      font-size: 12px;
      color: var(--gold);
      font-weight: 600;
      text-transform: uppercase;
    }

    .results-source-info .article-title-mini {
      font-size: 14px;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .results-preview {
      margin-bottom: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* Gamma Embed - Mobile First */
    #gamma-embed-container {
      width: 100%;
      aspect-ratio: 9/16;
      max-height: 65vh;
      min-height: 300px;
      border-radius: 12px;
      overflow: hidden;
      background: #1a1a2e;
      position: relative;
      margin: 0 auto;
    }

    #gamma-embed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Flipbook Carousel */
    .flipbook-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .flipbook {
      flex: 1;
      position: relative;
      background: var(--bg-card);
      border-radius: 20px;
      overflow: hidden;
      min-height: 280px;
    }

    .flip-slide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.4s ease;
      padding: 25px;
    }

    .flip-slide.active {
      opacity: 1;
      transform: translateX(0);
    }

    .flip-slide.prev {
      opacity: 0;
      transform: translateX(-100%);
    }

    .slide-content {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .slide-number {
      width: 40px;
      height: 40px;
      background: var(--gold);
      color: var(--bg-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .slide-title {
      font-size: 20px;
      font-weight: 700;
      line-height: 1.3;
      color: var(--gold);
    }

    .slide-body {
      font-size: 16px;
      line-height: 1.6;
      color: var(--text-muted);
    }

    .flipbook-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 15px;
    }

    .flip-prev, .flip-next {
      width: 44px;
      height: 44px;
      background: var(--bg-card);
      border: none;
      border-radius: 50%;
      font-size: 24px;
      color: var(--text);
      cursor: pointer;
    }

    .flip-prev:active, .flip-next:active {
      transform: scale(0.9);
    }

    .flip-dots {
      display: flex;
      gap: 8px;
    }

    .flip-dot {
      width: 8px;
      height: 8px;
      background: var(--bg-card);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
    }

    .flip-dot.active {
      background: var(--gold);
      width: 24px;
      border-radius: 4px;
    }

    .flipbook-hint {
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 15px;
    }

    .results-actions {
      margin-bottom: 30px;
    }

    .results-actions h3 {
      font-size: 14px;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 15px;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
    }

    .action-btn {
      flex: 1;
      padding: 20px 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      text-align: center;
      text-decoration: none;
      color: var(--text);
      transition: all 0.2s;
      border: 2px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .action-btn:active {
      transform: scale(0.95);
    }

    .action-btn .btn-icon {
      font-size: 28px;
      display: block;
      margin-bottom: 8px;
    }

    .action-btn .btn-label {
      font-size: 13px;
      font-weight: 600;
    }

    .action-btn.gamma:hover,
    .action-btn.gamma:active {
      border-color: var(--purple);
      background: rgba(168, 85, 247, 0.15);
    }

    .action-btn.download:hover,
    .action-btn.download:active {
      border-color: var(--green);
      background: rgba(74, 222, 128, 0.15);
    }

    .action-btn.linkedin:hover,
    .action-btn.linkedin:active {
      border-color: var(--blue);
      background: rgba(59, 130, 246, 0.15);
    }

    .linkedin-share-container {
      display: flex;
      justify-content: center;
      padding: 15px 20px;
    }

    .linkedin-share-btn {
      width: 100%;
      max-width: 360px;
      height: 50px;
      background: var(--gold);
      border: none;
      border-radius: 24px;
      font-size: 18px;
      font-weight: 700;
      color: #1a1a1a;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .linkedin-share-btn:hover,
    .linkedin-share-btn:active {
      background: var(--linkedin-blue);
      color: white;
      box-shadow: 0 0 20px rgba(10, 102, 194, 0.4);
    }

    .linkedin-share-btn:hover svg,
    .linkedin-share-btn:active svg {
      fill: white;
    }

    .results-post {
      margin-top: auto;
    }

    .post-final-btn {
      width: 100%;
      padding: 20px;
      background: var(--gold);
      border: none;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      color: var(--bg-primary);
      cursor: pointer;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: background 0.3s, color 0.3s;
    }

    .post-final-btn:hover,
    .post-final-btn:active {
      background: var(--linkedin-blue);
      color: white;
      transform: scale(0.97);
    }

    .skip-btn {
      width: 100%;
      padding: 16px;
      background: transparent;
      border: 2px solid var(--bg-card);
      border-radius: 16px;
      font-size: 16px;
      color: var(--text-muted);
      cursor: pointer;
    }

    /* Article Detail Modal */
    .article-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 22, 40, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 240;
      padding: 20px;
      overflow-y: auto;
    }

    .article-modal.show {
      display: flex;
    }

    .article-modal-content {
      width: 100%;
      max-width: 400px;
      background: white;
      border-radius: 20px;
      overflow: hidden;
      max-height: 90vh;
      overflow-y: auto;
    }

    .article-modal-image {
      width: 100%;
      height: 180px;
      background-size: cover;
      background-position: center;
    }

    .article-modal-body {
      padding: 20px;
    }

    .article-modal-source {
      display: inline-block;
      background: #f0f0f0;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: #666;
      margin-bottom: 12px;
    }

    .article-modal-title {
      font-size: 22px;
      font-weight: 700;
      color: #1a1a1a;
      line-height: 1.3;
      margin-bottom: 15px;
    }

    .article-modal-meta {
      display: flex;
      gap: 15px;
      font-size: 12px;
      color: #888;
      margin-bottom: 15px;
    }

    .article-modal-description {
      font-size: 14px;
      color: #444;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .ai-consensus {
      background: #f8f8f8;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .ai-consensus-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .ai-consensus-header .score {
      font-size: 28px;
      font-weight: 700;
      color: var(--gold);
    }

    .ai-consensus-header .label {
      font-size: 12px;
      color: #666;
    }

    .ai-consensus-text {
      font-size: 13px;
      color: #555;
      line-height: 1.5;
    }

    .article-modal-close {
      width: 100%;
      padding: 16px;
      background: #1a1a1a;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      cursor: pointer;
    }

    /* ============================================
       CARD GENERATION SCREEN
       ============================================ */
    #screen-generating {
      background: var(--bg-primary);
      justify-content: flex-start;
      padding: 15px 20px;
      overflow-y: auto;
    }

    .generating-header {
      text-align: center;
      margin-bottom: 12px;
    }

    .generating-header h1 {
      font-size: 18px;
      margin-bottom: 4px;
      color: var(--gold);
    }

    /* Gamma Logo Highlight */
    .gamma-highlight {
      display: flex;
      justify-content: center;
      margin-bottom: 12px;
    }

    .gamma-logo-box {
      background: var(--bg-card);
      border: 1px solid var(--gold);
      padding: 12px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
      animation: gamma-glow 2s ease-in-out infinite;
    }

    .gamma-logo-box img {
      width: 48px;
      height: 48px;
    }

    @keyframes gamma-glow {
      0%, 100% { box-shadow: 0 0 30px rgba(212, 175, 55, 0.3); }
      50% { box-shadow: 0 0 50px rgba(212, 175, 55, 0.5); }
    }

    .gen-article-title {
      color: var(--gold);
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      max-width: 280px;
      margin: 8px auto 0;
      line-height: 1.3;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    /* Card Counter */
    .card-counter {
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: white;
      margin-bottom: 10px;
    }

    .card-counter span {
      color: var(--gold);
    }

    /* Single Progress Card */
    .generation-cards {
      display: flex;
      justify-content: center;
      margin-bottom: 12px;
    }

    .gen-card-single {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(212, 175, 55, 0.4);
    }

    .gen-card-single .step-num {
      font-size: 36px;
      font-weight: 700;
      color: var(--bg-primary);
      line-height: 1;
      transition: transform 0.15s ease;
    }

    .gen-card-single .step-total {
      font-size: 12px;
      color: var(--bg-primary);
      opacity: 0.7;
    }

    .gen-step-description {
      text-align: center;
      font-size: 13px;
      color: var(--text);
      margin-bottom: 15px;
      min-height: 20px;
      transition: opacity 0.2s ease;
    }

    .gen-card-inner {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s ease;
    }

    .gen-card.flipped .gen-card-inner {
      transform: rotateY(180deg);
    }

    .gen-card-front, .gen-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }

    .gen-card-front {
      background: var(--bg-card);
      border: 2px solid rgba(255,255,255,0.1);
    }

    .gen-card-front .card-num {
      font-size: 12px;
      font-weight: 700;
      color: rgba(255,255,255,0.3);
    }

    .gen-card-back {
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
      transform: rotateY(180deg);
    }

    .gen-card-back .card-icon {
      font-size: 14px;
      margin-bottom: 2px;
    }

    .gen-card-back .card-step {
      font-size: 6px;
      font-weight: 600;
      color: var(--bg-primary);
      text-align: center;
      line-height: 1;
      padding: 0 2px;
      display: none;
    }

    .gen-card.flipping .gen-card-inner {
      animation: card-flip-bounce 0.6s ease;
    }

    @keyframes card-flip-bounce {
      0% { transform: rotateY(0deg) scale(1); }
      50% { transform: rotateY(90deg) scale(1.1); }
      100% { transform: rotateY(180deg) scale(1); }
    }

    /* AI Commentary Box */
    .ai-commentary {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 12px;
    }

    .ai-commentary-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .ai-commentary-header .ai-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      object-fit: cover;
    }

    .ai-commentary-header .ai-name {
      font-weight: 600;
      font-size: 12px;
    }

    .ai-commentary-header .typing-dots {
      display: none;
      gap: 3px;
    }

    .ai-commentary-header .typing-dots.active {
      display: flex;
    }

    .ai-commentary-header .typing-dots span {
      width: 4px;
      height: 4px;
      background: var(--gold);
      border-radius: 50%;
      animation: typing-bounce 1.4s infinite both;
    }

    .ai-commentary-header .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .ai-commentary-header .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing-bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    .ai-commentary-text {
      font-size: 11px;
      line-height: 1.4;
      color: var(--text-muted);
      min-height: 28px;
    }

    /* Progress Bar */
    .generation-progress {
      background: var(--bg-card);
      border-radius: 6px;
      height: 6px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .generation-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold) 0%, var(--gold-light) 100%);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 10px;
    }

    .generation-percent {
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
      margin: 0;
    }

    /* Posted Success Modal */
    .success-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 22, 40, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 300;
      padding: 30px;
    }

    .success-modal.show {
      display: flex;
    }

    .success-modal-content {
      text-align: center;
    }

    .success-modal .success-icon {
      font-size: 80px;
      margin-bottom: 20px;
    }

    .success-modal .success-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--green);
    }

    .success-modal .success-subtitle {
      font-size: 16px;
      color: var(--text-muted);
      margin-bottom: 30px;
    }

    .success-modal .view-post-btn {
      display: inline-block;
      padding: 16px 40px;
      background: var(--blue);
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      text-decoration: none;
      margin-bottom: 15px;
    }

    .success-modal .new-post-btn {
      display: block;
      padding: 16px 30px;
      background: var(--bg-card);
      border: none;
      border-radius: 16px;
      font-size: 16px;
      color: var(--text);
      cursor: pointer;
      margin: 0 auto;
    }
    /* ============================================
       SCREEN 0: INTRO
       ============================================ */
    #screen-intro {
      justify-content: center;
      align-items: center;
      padding: 30px 24px;
      background: var(--bg-primary);
    }
    .intro-logo-container {
      display: flex; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 40px;
    }
    .intro-logo { width: 120px; height: 120px; }
    .intro-logo img { width: 100%; height: 100%; object-fit: contain; }
    .intro-title { font-size: 28px; font-weight: 700; color: var(--gold); letter-spacing: 1px; text-align: center; }
    .intro-subtitle { font-size: 14px; color: var(--text-muted); text-align: center; }
    .intro-steps {
      width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 16px; margin-bottom: 36px;
    }
    .intro-step {
      display: flex; align-items: center; gap: 16px;
      background: var(--bg-secondary); border-radius: 14px; padding: 14px 16px;
      border: 1px solid rgba(212, 175, 55, 0.15);
    }
    .intro-step .step-num-badge {
      font-size: 16px; font-weight: 700; color: var(--gold);
      width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
      background: rgba(212, 175, 55, 0.1); border-radius: 50%; flex-shrink: 0;
    }
    .intro-step .step-text { display: flex; flex-direction: column; gap: 2px; }
    .intro-step .step-label { font-size: 13px; font-weight: 700; color: var(--text); }
    .intro-step .step-desc { font-size: 11px; color: var(--text-muted); line-height: 1.3; }
    .intro-cta-btn {
      width: 100%; max-width: 320px; padding: 18px;
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
      border: none; border-radius: 20px; font-size: 18px; font-weight: 700;
      color: var(--bg-primary); cursor: pointer;
      box-shadow: 0 4px 20px rgba(212, 175, 55, 0.4);
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .intro-cta-btn:active { transform: scale(0.97); box-shadow: 0 2px 10px rgba(212, 175, 55, 0.3); }

    /* Help button on home screen */
    .help-btn {
      position: absolute; top: calc(var(--safe-top) + 12px); right: 16px;
      width: 36px; height: 36px; border-radius: 50%;
      background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3);
      color: var(--gold); font-size: 18px; font-weight: 700; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }

    /* Fetching indicator */
    .topic-fetching-indicator {
      text-align: center; margin-top: 12px; font-size: 13px; color: var(--gold);
      opacity: 0; transition: opacity 0.3s; height: 20px;
    }
    .topic-fetching-indicator.visible { opacity: 1; }

    /* Two-phase generating */
    .gen-phase-1 {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 20px; width: 100%; flex: 1;
    }
    .gen-phase-1-logo {
      width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--gold);
      display: flex; align-items: center; justify-content: center;
      animation: pulse-glow 2s ease-in-out infinite;
    }
    .gen-phase-1-logo img { width: 80px; height: 80px; object-fit: contain; }
    .gen-phase-1-message { font-size: 18px; font-weight: 600; color: white; text-align: center; max-width: 260px; line-height: 1.4; }
    .gen-phase-1-sub { font-size: 13px; color: var(--text-muted); text-align: center; max-width: 280px; }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 30px rgba(212, 175, 55, 0.3); transform: scale(1); }
      50% { box-shadow: 0 0 60px rgba(212, 175, 55, 0.6); transform: scale(1.04); }
    }
    .gen-phase-2 { display: none; flex-direction: column; align-items: center; width: 100%; }
    .gen-phase-2.active { display: flex; }

    /* LinkedIn hidden until ready */
    .linkedin-share-container.hidden { display: none; }
    .linkedin-share-container.reveal { animation: fadeInUp 0.5s ease forwards; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div class="app">

    <!-- SCREEN 0: INTRO (first visit only) -->
    <div id="screen-intro" class="screen">
      <div class="intro-logo-container">
        <div class="intro-logo"><img src="assets/logo-white.png" alt="AI Radar"></div>
        <div class="intro-title">AI Radar</div>
        <div class="intro-subtitle">by JJ Shay</div>
      </div>
      <div class="intro-steps">
        <div class="intro-step">
          <div class="step-num-badge">1</div>
          <div class="step-text">
            <span class="step-label">Pick your industry</span>
            <span class="step-desc">Choose from 20+ industries and sectors</span>
          </div>
        </div>
        <div class="intro-step">
          <div class="step-num-badge">2</div>
          <div class="step-text">
            <span class="step-label">Browse AI-scored articles</span>
            <span class="step-desc">5 AI models rank the most relevant news</span>
          </div>
        </div>
        <div class="intro-step">
          <div class="step-num-badge">3</div>
          <div class="step-text">
            <span class="step-label">Swipe right to create</span>
            <span class="step-desc">Turn any article into a LinkedIn presentation</span>
          </div>
        </div>
        <div class="intro-step">
          <div class="step-num-badge">4</div>
          <div class="step-text">
            <span class="step-label">Share to LinkedIn</span>
            <span class="step-desc">Post AI-generated slides with one tap</span>
          </div>
        </div>
      </div>
      <button class="intro-cta-btn" onclick="startFromIntro()">Get Started</button>
    </div>

    <!-- SCREEN 1: HOME -->
    <div id="screen-home" class="screen">
      <button class="help-btn" onclick="showIntro()" title="How it works">?</button>

      <div class="logo-container">
        <div class="logo-icon">
          <img src="assets/logo-white.png" alt="AI Radar">
        </div>
        <div class="logo-tagline">Intelligence Engine</div>
      </div>

      <!-- Industry Picker -->
      <div class="topic-selector">
        <label>Pick Your Industry</label>
        <select id="topic-dropdown" onchange="onIndustrySelect(this.value)">
          <option value="" disabled selected>Choose an industry...</option>
          <optgroup label="AI & Technology">
            <option value="artificial intelligence">Artificial Intelligence</option>
            <option value="machine learning">Machine Learning</option>
            <option value="large language models">Large Language Models</option>
            <option value="robotics">Robotics</option>
            <option value="autonomous vehicles">Autonomous Vehicles</option>
            <option value="quantum computing">Quantum Computing</option>
            <option value="edge computing">Edge Computing</option>
          </optgroup>
          <optgroup label="Business & Finance">
            <option value="startups">Startups & VC</option>
            <option value="fintech">Fintech</option>
            <option value="cryptocurrency">Cryptocurrency</option>
            <option value="stock market">Stock Market</option>
            <option value="private equity">Private Equity</option>
            <option value="mergers and acquisitions">Mergers & Acquisitions</option>
          </optgroup>
          <optgroup label="Industry">
            <option value="healthcare ai">Healthcare AI</option>
            <option value="climate tech">Climate Tech</option>
            <option value="cybersecurity">Cybersecurity</option>
            <option value="space technology">Space Technology</option>
            <option value="manufacturing automation">Manufacturing</option>
            <option value="retail technology">Retail Tech</option>
            <option value="supply chain ai">Supply Chain</option>
            <option value="proptech">Proptech</option>
          </optgroup>
        </select>
      </div>

      <div class="topic-fetching-indicator" id="topic-fetching-indicator">Fetching articles...</div>

    </div>

    <!-- SCREEN 2: AI SCORING ANIMATION -->
    <div id="screen-scoring" class="screen" style="justify-content: center; align-items: center; padding: 40px 20px;">
      <div style="text-align: center; margin-bottom: 40px;">
        <h2 style="font-size: 24px; margin-bottom: 10px; color: var(--gold);">Analyzing Articles</h2>
        <p style="color: var(--text-muted); font-size: 14px;">5 AI models scoring your articles...</p>
      </div>

      <!-- AI Logos with animated dots -->
      <div id="ai-scoring-dots" style="display: flex; gap: 20px; margin-bottom: 40px;">
        <div class="ai-score-logo" id="score-gpt" style="display: flex; flex-direction: column; align-items: center; opacity: 0.3; transition: all 0.5s;">
          <img src="logos/chatgpt.png" alt="ChatGPT" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
          <span style="font-size: 10px; margin-top: 5px; color: var(--text-muted);">GPT</span>
        </div>
        <div class="ai-score-logo" id="score-claude" style="display: flex; flex-direction: column; align-items: center; opacity: 0.3; transition: all 0.5s;">
          <img src="logos/claude.png" alt="Claude" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
          <span style="font-size: 10px; margin-top: 5px; color: var(--text-muted);">Claude</span>
        </div>
        <div class="ai-score-logo" id="score-gemini" style="display: flex; flex-direction: column; align-items: center; opacity: 0.3; transition: all 0.5s;">
          <img src="logos/gemini.png" alt="Gemini" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
          <span style="font-size: 10px; margin-top: 5px; color: var(--text-muted);">Gemini</span>
        </div>
        <div class="ai-score-logo" id="score-grok" style="display: flex; flex-direction: column; align-items: center; opacity: 0.3; transition: all 0.5s;">
          <img src="logos/grok.png" alt="Grok" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #333;">
          <span style="font-size: 10px; margin-top: 5px; color: var(--text-muted);">Grok</span>
        </div>
        <div class="ai-score-logo" id="score-pplx" style="display: flex; flex-direction: column; align-items: center; opacity: 0.3; transition: all 0.5s;">
          <img src="logos/perplexity.png" alt="Perplexity" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #fff;">
          <span style="font-size: 10px; margin-top: 5px; color: var(--text-muted);">Pplx</span>
        </div>
      </div>

      <div id="scoring-status" style="color: var(--text-muted); font-size: 14px;">Initializing...</div>
      <div id="scoring-count" style="color: var(--gold); font-size: 18px; margin-top: 10px; font-weight: bold;">0 articles scored</div>
    </div>

    <!-- SCREEN 3: SWIPE CARDS -->
    <div id="screen-swipe" class="screen">
      <div class="swipe-header">
        <button class="back-btn" onclick="showScreen('home')">← Back</button>
        <div class="swipe-card-counter" id="swipe-card-counter">Card <span>1</span> of <span>0</span></div>
        <div></div>
      </div>

      <div class="card-stack" id="card-stack">
        <!-- Cards inserted dynamically -->
        <div class="swipe-indicator left">SKIP</div>
        <div class="swipe-indicator right">CREATE</div>
        <div class="swipe-indicator up">HOME</div>
        <div class="swipe-indicator down">BACK</div>
      </div>

      <div class="swipe-hints">
        <div class="hint not">
          <div class="arrow">← SKIP</div>
        </div>
        <div class="hint save">
          <div class="arrow">↑ HOME</div>
        </div>
        <div class="hint delete">
          <div class="arrow">↓ BACK</div>
        </div>
        <div class="hint create">
          <div class="arrow">CREATE →</div>
        </div>
      </div>
    </div>

    <!-- SCREEN 5: RESULTS (Human in the Loop) -->
    <div id="screen-results" class="screen">
      <div class="results-header">
        <h1>Your Presentation</h1>
        <p class="results-subtitle">Review and share your content</p>
      </div>

      <!-- Article Source Info -->
      <div class="results-source-info" id="results-source-info">
        <img src="" alt="" class="source-logo" id="results-source-logo">
        <div class="source-details">
          <span class="source-name" id="results-source-name">Source</span>
          <span class="article-title-mini" id="results-article-title">Article Title</span>
        </div>
      </div>

      <div class="results-preview">
        <!-- Gamma Embed (shows real slides - mobile optimized) -->
        <div id="gamma-embed-container" style="display: none;">
          <iframe id="gamma-embed" src="" allowfullscreen></iframe>
        </div>

        <!-- Fallback Flipbook (when no Gamma URL) -->
        <div class="flipbook-container" id="flipbook-container">
          <div class="flipbook" id="flipbook">
            <div class="flip-slide active" data-slide="1">
              <div class="slide-content">
                <div class="slide-number">1</div>
                <div class="slide-title" id="slide-title-1">Loading...</div>
              </div>
            </div>
            <div class="flip-slide" data-slide="2">
              <div class="slide-content">
                <div class="slide-number">2</div>
                <div class="slide-body">Key insights from the article...</div>
              </div>
            </div>
            <div class="flip-slide" data-slide="3">
              <div class="slide-content">
                <div class="slide-number">3</div>
                <div class="slide-body">Main points and analysis...</div>
              </div>
            </div>
            <div class="flip-slide" data-slide="4">
              <div class="slide-content">
                <div class="slide-number">4</div>
                <div class="slide-body">Industry implications...</div>
              </div>
            </div>
            <div class="flip-slide" data-slide="5">
              <div class="slide-content">
                <div class="slide-number">5</div>
                <div class="slide-body">Call to action & conclusion</div>
              </div>
            </div>
          </div>
          <div class="flipbook-nav">
            <button class="flip-prev" onclick="flipPrev()">‹</button>
            <div class="flip-dots" id="flip-dots">
              <span class="flip-dot active" data-index="0"></span>
              <span class="flip-dot" data-index="1"></span>
              <span class="flip-dot" data-index="2"></span>
              <span class="flip-dot" data-index="3"></span>
              <span class="flip-dot" data-index="4"></span>
            </div>
            <button class="flip-next" onclick="flipNext()">›</button>
          </div>
          <div class="flipbook-hint">Swipe to preview slides</div>
        </div>
      </div>

      <div class="results-actions">
        <h3>Open in:</h3>
        <div class="action-buttons">
          <a href="#" class="action-btn gamma" id="gamma-link" target="_blank">
            <span class="btn-icon">
              <svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
              </svg>
            </span>
            <span class="btn-label">Gamma</span>
          </a>
          <a href="#" class="action-btn download" id="download-link" target="_blank">
            <span class="btn-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="28" height="28">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
            </span>
            <span class="btn-label">Download</span>
          </a>
        </div>
      </div>

      <div class="linkedin-share-container hidden" id="linkedin-share-container">
        <button class="linkedin-share-btn" onclick="shareOnLinkedIn()">
          Share on
          <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24" style="vertical-align: middle; margin: 0 6px;">
            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
          </svg>
          LinkedIn
        </button>
      </div>

      <div class="results-post">
        <button class="skip-btn" onclick="skipAndNext()">
          Next Article
        </button>
      </div>
    </div>


    <!-- Article Detail Modal -->
    <div class="article-modal" id="article-modal">
      <div class="article-modal-content">
        <div class="article-modal-image" id="modal-image"></div>
        <div class="article-modal-body">
          <div class="article-modal-source" id="modal-source">Source</div>
          <h2 class="article-modal-title" id="modal-title">Article Title</h2>
          <div class="article-modal-meta">
            <span id="modal-date">Today</span>
            <span id="modal-pages">3 pages</span>
          </div>
          <p class="article-modal-description" id="modal-description">
            Full article description goes here...
          </p>

          <div class="ai-consensus">
            <div class="ai-consensus-header">
              <span class="score" id="modal-score">8.5</span>
              <span class="label">AI Consensus Score</span>
            </div>
            <p class="ai-consensus-text" id="modal-consensus">
              All 5 AI models agree this article has high relevance and engagement potential.
              Strong news value with timely topic coverage and credible sourcing.
            </p>
          </div>

          <button class="article-modal-close" onclick="hideArticleModal()">Close</button>
        </div>
      </div>
    </div>

    <!-- SCREEN: Card Generation -->
    <div id="screen-generating" class="screen" style="justify-content: center; align-items: center; padding: 20px; position: relative;">
      <button class="abort-btn" onclick="abortGeneration()" title="Cancel">✕</button>

      <!-- PHASE 1: "Your slides are being created" -->
      <div class="gen-phase-1" id="gen-phase-1">
        <div class="gen-phase-1-logo">
          <img src="assets/logo-white.png" alt="AI Radar" style="width: 80px; height: 80px; object-fit: contain;">
        </div>
        <h2 style="color: var(--gold); font-size: 22px; margin: 24px 0 8px; font-weight: 700;">Your slides are being created</h2>
        <p class="gen-article-title" id="gen-article-title" style="color: var(--text-muted); font-size: 14px; text-align: center; max-width: 280px; line-height: 1.4;"></p>
      </div>

      <!-- PHASE 2: AI progress + audio (hidden initially) -->
      <div class="gen-phase-2" id="gen-phase-2">
        <!-- AI Logos -->
        <div style="display: flex; gap: 16px; margin-bottom: 20px;">
          <div style="display: flex; flex-direction: column; align-items: center; opacity: 0.6;">
            <img src="logos/chatgpt.png" alt="GPT" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          </div>
          <div style="display: flex; flex-direction: column; align-items: center; opacity: 0.6;">
            <img src="logos/claude.png" alt="Claude" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          </div>
          <div style="display: flex; flex-direction: column; align-items: center; opacity: 0.6;">
            <img src="logos/gemini.png" alt="Gemini" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          </div>
          <div style="display: flex; flex-direction: column; align-items: center; opacity: 0.6;">
            <img src="logos/grok.png" alt="Grok" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #333;">
          </div>
        </div>

        <!-- Step Card -->
        <div class="generation-cards">
          <div class="gen-card-single">
            <div class="step-num" id="step-num">1</div>
            <div class="step-total" id="step-total">of 12</div>
          </div>
        </div>

        <!-- Step Description -->
        <p class="gen-step-description" id="gen-step-description">Analyzing article content...</p>

        <!-- Progress -->
        <div style="width: 100%; max-width: 250px;">
          <div class="generation-progress">
            <div class="generation-progress-fill" id="gen-progress-fill"></div>
          </div>
          <p class="generation-percent" id="gen-percent">0%</p>
        </div>
      </div>

      <!-- Audio controls (visible in both phases) -->
      <div style="margin: 16px 0; display: flex; flex-direction: column; align-items: center; gap: 6px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <button id="audio-btn" onclick="toggleAudioSummary()" disabled style="background: var(--gold); border: none; padding: 10px 24px; border-radius: 24px; font-size: 14px; font-weight: 700; color: var(--bg-primary); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.15s, box-shadow 0.15s; box-shadow: 0 2px 12px rgba(212,175,55,0.3); opacity: 0.5;">
            <span id="audio-icon">🎧</span> <span id="audio-text">Preparing Audio...</span>
          </button>
          <button id="audio-stop-btn" class="audio-stop-btn" onclick="stopAudio()" style="display: none;">⏹ Stop</button>
        </div>
        <span id="audio-status" style="font-size: 11px; color: var(--text-muted);"></span>
      </div>
      <audio id="summary-audio" style="display: none;"></audio>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
      <div class="spinner"></div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="success-modal">
      <div class="success-modal-content">
        <div class="success-icon">✅</div>
        <h1 class="success-title">Created!</h1>
        <p class="success-subtitle">Your presentation is ready to share</p>
        <a href="#" class="view-post-btn" id="gamma-view-btn" target="_blank">Open in Gamma</a>
        <button class="new-post-btn" onclick="resetAndGoHome()">Create Another</button>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>
  </div>

  <script>
    // ============================================
    // STATE
    // ============================================
    // API_BASE: Update PRODUCTION_API after deploying backend to Railway
    const PRODUCTION_API = 'https://web-production-08a17.up.railway.app';
    const API_BASE = window.location.hostname === 'localhost'
      ? 'http://localhost:5050'
      : PRODUCTION_API;
    // HTML escaping for XSS prevention
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    // Audio summary state
    let isAudioPlaying = false;
    let cachedAudioUrl = null;

    // Inspiring quotes for audio intros
    const inspiringQuotes = [
      "As Maya Angelou said, 'There is no greater agony than bearing an untold story inside you.'",
      "In the words of Steve Jobs, 'Innovation distinguishes between a leader and a follower.'",
      "Oscar Wilde reminded us, 'Be yourself; everyone else is already taken.'",
      "As Albert Einstein said, 'Imagination is more important than knowledge.'",
      "In the words of Rumi, 'What you seek is seeking you.'",
      "Marie Curie said, 'Nothing in life is to be feared, it is only to be understood.'",
      "As Walt Disney said, 'The way to get started is to quit talking and begin doing.'",
      "Leonardo da Vinci wrote, 'Learning never exhausts the mind.'",
      "As Nelson Mandela said, 'It always seems impossible until it's done.'",
      "In the words of Coco Chanel, 'In order to be irreplaceable, one must always be different.'"
    ];

    // Audio summary - uses backend proxy for TTS
    let audioReadyButWaiting = false;

    async function generateAudioSummaryPhased(article) {
      const statusEl = document.getElementById('audio-status');
      const btnEl = document.getElementById('audio-btn');
      const iconEl = document.getElementById('audio-icon');
      const textEl = document.getElementById('audio-text');
      const audioEl = document.getElementById('summary-audio');

      if (!article) return;

      // Reset state
      cachedAudioUrl = null;
      audioReadyButWaiting = false;
      if (statusEl) statusEl.textContent = 'Generating audio...';

      try {
        const quote = inspiringQuotes[Math.floor(Math.random() * inspiringQuotes.length)];
        const outro = ' ... Visit jjshay.com for over 70 free AI reports. Stay informed, stay ahead.';
        const fullSummary = (article.summary || article.description || '') + ' ... ' + quote + outro;
        const response = await fetch(`${API_BASE}/audio-summary`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: article.title,
            source: article.source || '',
            summary: fullSummary,
            quote: quote
          }),
          signal: AbortSignal.timeout(20000)
        });

        if (!response.ok) throw new Error('Failed to generate audio');

        const audioBlob = await response.blob();
        cachedAudioUrl = URL.createObjectURL(audioBlob);
        audioEl.src = cachedAudioUrl;

        // Enable the play button
        if (btnEl) {
          btnEl.disabled = false;
          btnEl.style.opacity = '1';
        }
        if (textEl) textEl.textContent = 'Listen to Summary';
        if (statusEl) statusEl.textContent = 'Audio ready';

        // Mark as ready - phase 2 transition will auto-play if it's already showing
        audioReadyButWaiting = true;
        autoPlayAudioIfReady();

      } catch (error) {
        console.error('Audio generation error:', error);
        if (statusEl) statusEl.textContent = 'Audio unavailable';
        if (btnEl) {
          btnEl.disabled = true;
          btnEl.style.opacity = '0.5';
        }
        if (textEl) textEl.textContent = 'Audio Unavailable';
      }
    }

    function autoPlayAudioIfReady() {
      if (!audioReadyButWaiting || !cachedAudioUrl) return;

      const phase2 = document.getElementById('gen-phase-2');
      if (!phase2 || !phase2.classList.contains('active')) return;

      // Phase 2 is showing and audio is ready - try to auto-play
      const audioEl = document.getElementById('summary-audio');
      const iconEl = document.getElementById('audio-icon');
      const textEl = document.getElementById('audio-text');
      const statusEl = document.getElementById('audio-status');
      const stopBtn = document.getElementById('audio-stop-btn');

      audioReadyButWaiting = false;

      const playPromise = audioEl.play();
      if (playPromise) {
        playPromise.then(() => {
          isAudioPlaying = true;
          if (iconEl) iconEl.textContent = '⏸️';
          if (textEl) textEl.textContent = 'Pause';
          if (statusEl) statusEl.textContent = 'Playing...';
          if (stopBtn) stopBtn.style.display = 'inline-block';
        }).catch(() => {
          // Browser blocked autoplay - user must tap to play
          console.log('Autoplay blocked, user must tap play button');
          if (statusEl) statusEl.textContent = 'Tap to play';
        });
      }

      const fmtTime = (s) => {
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return `${m}:${sec < 10 ? '0' : ''}${sec}`;
      };
      audioEl.ontimeupdate = () => {
        if (statusEl) {
          const elapsed = fmtTime(audioEl.currentTime);
          if (audioEl.duration && isFinite(audioEl.duration)) {
            statusEl.textContent = `${elapsed} / ${fmtTime(audioEl.duration)}`;
          } else {
            statusEl.textContent = `${elapsed} playing`;
          }
        }
      };
      audioEl.onended = () => {
        audioEl.ontimeupdate = null;
        isAudioPlaying = false;
        if (iconEl) iconEl.textContent = '🎧';
        if (textEl) textEl.textContent = 'Replay';
        if (statusEl) statusEl.textContent = '';
        if (stopBtn) stopBtn.style.display = 'none';
      };
    }

    // Legacy wrapper for toggleAudioSummary compatibility
    async function generateAudioSummary(article) {
      return generateAudioSummaryPhased(article);
    }

    function toggleAudioSummary() {
      const audioEl = document.getElementById('summary-audio');
      const iconEl = document.getElementById('audio-icon');
      const textEl = document.getElementById('audio-text');
      const statusEl = document.getElementById('audio-status');
      const stopBtn = document.getElementById('audio-stop-btn');

      if (!cachedAudioUrl) {
        generateAudioSummary(selectedArticle);
      } else if (isAudioPlaying) {
        audioEl.pause();
        isAudioPlaying = false;
        iconEl.textContent = '▶️';
        textEl.textContent = 'Resume';
        statusEl.textContent = 'Paused';
        if (stopBtn) stopBtn.style.display = 'inline-block';
      } else {
        audioEl.play();
        isAudioPlaying = true;
        iconEl.textContent = '⏸️';
        textEl.textContent = 'Pause';
        statusEl.textContent = 'Playing...';
        if (stopBtn) stopBtn.style.display = 'inline-block';
      }
    }

    function stopAudio() {
      resetAudioState();
      const stopBtn = document.getElementById('audio-stop-btn');
      if (stopBtn) stopBtn.style.display = 'none';
    }

    function resetAudioState() {
      const iconEl = document.getElementById('audio-icon');
      const textEl = document.getElementById('audio-text');
      const statusEl = document.getElementById('audio-status');
      const audioEl = document.getElementById('summary-audio');

      if (audioEl) {
        audioEl.pause();
        audioEl.src = '';
      }
      if (cachedAudioUrl) {
        URL.revokeObjectURL(cachedAudioUrl);
        cachedAudioUrl = null;
      }
      isAudioPlaying = false;

      if (iconEl) iconEl.textContent = '🎧';
      if (textEl) textEl.textContent = 'Listen';
      if (statusEl) statusEl.textContent = '';
    }

    let articles = [];
    let favorites = JSON.parse(localStorage.getItem('ai-radar-favorites') || '[]');
    let currentCardIndex = 0;
    let selectedArticle = null;
    let selectedLength = 'medium';
    let selectedTopic = 'artificial intelligence';

    // ============================================
    // INTRO SCREEN (first-visit only)
    // ============================================
    const INTRO_SEEN_KEY = 'ai-radar-intro-seen';

    function checkAndShowIntro() {
      if (!localStorage.getItem(INTRO_SEEN_KEY)) {
        document.getElementById('screen-home').classList.remove('active');
        showScreen('intro');
      } else {
        showScreen('home');
      }
    }

    function startFromIntro() {
      localStorage.setItem(INTRO_SEEN_KEY, 'true');
      showScreen('home');
    }

    function showIntro() {
      showScreen('intro');
    }

    // Global topic keywords for learning and display
    const topicKeywords = ['AI', 'GPT', 'OpenAI', 'Google', 'Microsoft', 'Apple', 'Tesla', 'Crypto', 'Startup', 'Enterprise', 'Cloud', 'Data', 'Robot', 'Quantum', 'Meta', 'Amazon', 'ChatGPT', 'Gemini', 'Claude', 'Machine Learning', 'Deep Learning', 'Neural', 'Nvidia', 'Anthropic'];

    // ============================================
    // LEARNING SYSTEM - Track user preferences
    // ============================================
    // Google Sheets Feedback Storage
    const FEEDBACK_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyCfVoFCmq4jTZrXn6mJ75hWemq99IeiHgtxqbFZ2RLx28VNCkAgZy_Rgv_jERe_vfX/exec';

    let userFeedback = JSON.parse(localStorage.getItem('ai-radar-feedback') || '{"dislikedTopics":{},"dislikedSources":{},"dislikedKeywords":{},"likedTopics":{},"likedSources":{}}');

    // Sync feedback to Google Sheets
    async function syncFeedbackToSheets(action, article, topics, keywords) {
      const feedbackRow = {
        timestamp: new Date().toISOString(),
        action: action, // 'like' or 'dislike'
        articleTitle: article.title,
        articleSource: article.source || '',
        topics: topics.join(', '),
        keywords: (keywords || []).slice(0, 10).join(', '),
        articleId: article.id || ''
      };

      // Try to send to Google Sheets via Apps Script
      try {
        const response = await fetch(FEEDBACK_APPS_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors', // Apps Script requires no-cors
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(feedbackRow)
        });
        console.log('Feedback synced to Sheets:', feedbackRow);
      } catch (err) {
        console.log('Sheets sync failed (offline mode):', err.message);
        // Still works offline via localStorage
      }
    }

    function recordNotInterested(article) {
      // Extract topics from title
      const titleWords = article.title.toUpperCase().split(/\s+/);
      const topics = topicKeywords.filter(t => titleWords.includes(t.toUpperCase()));

      // Increment dislike counts for topics
      topics.forEach(topic => {
        userFeedback.dislikedTopics[topic] = (userFeedback.dislikedTopics[topic] || 0) + 1;
      });

      // Increment dislike for source
      if (article.source) {
        userFeedback.dislikedSources[article.source] = (userFeedback.dislikedSources[article.source] || 0) + 1;
      }

      // Extract key words from title (3+ chars, not common words)
      const stopWords = ['THE', 'AND', 'FOR', 'ARE', 'BUT', 'NOT', 'YOU', 'ALL', 'CAN', 'HER', 'WAS', 'ONE', 'OUR', 'OUT', 'WITH', 'THIS', 'THAT', 'FROM', 'HAVE', 'WILL', 'YOUR', 'WHAT', 'HOW', 'WHY', 'NEW'];
      const keywords = titleWords.filter(w => w.length > 3 && !stopWords.includes(w));
      keywords.forEach(kw => {
        userFeedback.dislikedKeywords[kw] = (userFeedback.dislikedKeywords[kw] || 0) + 1;
      });

      localStorage.setItem('ai-radar-feedback', JSON.stringify(userFeedback));
      console.log('Recorded dislike:', { topics, source: article.source, keywords: keywords.slice(0, 5) });

      // Sync to Google Sheets
      syncFeedbackToSheets('dislike', article, topics, keywords);
    }

    function recordInterested(article) {
      // Extract topics from title
      const titleWords = article.title.toUpperCase().split(/\s+/);
      const topics = topicKeywords.filter(t => titleWords.includes(t.toUpperCase()));

      // Increment like counts for topics
      topics.forEach(topic => {
        userFeedback.likedTopics[topic] = (userFeedback.likedTopics[topic] || 0) + 1;
      });

      // Increment like for source
      if (article.source) {
        userFeedback.likedSources[article.source] = (userFeedback.likedSources[article.source] || 0) + 1;
      }

      localStorage.setItem('ai-radar-feedback', JSON.stringify(userFeedback));
      console.log('Recorded like:', { topics, source: article.source });

      // Sync to Google Sheets
      syncFeedbackToSheets('like', article, topics, []);
    }

    function calculateRelevanceScore(article) {
      let score = 0;
      const titleWords = article.title.toUpperCase().split(/\s+/);
      const topics = topicKeywords.filter(t => titleWords.includes(t.toUpperCase()));

      // Boost for liked topics/sources
      topics.forEach(topic => {
        score += (userFeedback.likedTopics[topic] || 0) * 2;
        score -= (userFeedback.dislikedTopics[topic] || 0) * 3;
      });

      if (article.source) {
        score += (userFeedback.likedSources[article.source] || 0) * 2;
        score -= (userFeedback.dislikedSources[article.source] || 0) * 3;
      }

      // Penalize disliked keywords
      titleWords.forEach(word => {
        if (userFeedback.dislikedKeywords[word] >= 2) {
          score -= userFeedback.dislikedKeywords[word];
        }
      });

      return score;
    }

    function sortArticlesByRelevance(articleList) {
      return articleList.sort((a, b) => {
        const scoreA = calculateRelevanceScore(a);
        const scoreB = calculateRelevanceScore(b);
        return scoreB - scoreA; // Higher scores first
      });
    }

    // ============================================
    // GOOGLE SHEETS INTEGRATION
    // ============================================
    function parseCSV(csvText) {
      const lines = csvText.split('\n');
      const headers = parseCSVLine(lines[0]);
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
          const values = parseCSVLine(lines[i]);
          const row = {};
          headers.forEach((header, idx) => {
            row[header.trim()] = values[idx] || '';
          });
          rows.push(row);
        }
      }
      return rows;
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }


    // ============================================
    // SOURCE SELECTION
    // ============================================
    // ============================================
    // INDUSTRY SELECT + AUTO-FETCH
    // ============================================
    async function onIndustrySelect(topic) {
      if (!topic) return;
      selectedTopic = topic;
      articles = [];
      currentCardIndex = 0;

      // Show fetching indicator
      const indicator = document.getElementById('topic-fetching-indicator');
      if (indicator) indicator.classList.add('visible');

      // Brief visual pause then auto-fetch
      await sleep(600);
      await fetchAllSourcesAuto();
    }

    async function fetchAllSourcesAuto() {
      // Run all 6 API calls in TRUE parallel (not sequential sub-calls)
      const fetchers = [
        fetchSource('newsapi'),
        fetchSource('newsdata'),
        fetchPerplexityBreaking(),
        fetchPerplexityAnalysis(),
        fetchGrokAnalysis(),
        fetchGrokPredictions()
      ];

      const results = await Promise.allSettled(fetchers);

      // Log per-source counts
      const counts = {};
      articles.forEach(a => { counts[a.source] = (counts[a.source] || 0) + 1; });
      console.log('Per-source article counts:', JSON.stringify(counts));

      // Hide fetching indicator
      const indicator = document.getElementById('topic-fetching-indicator');
      if (indicator) indicator.classList.remove('visible');

      console.log(`Fetched ${articles.length} articles from 6 parallel calls`);

      // Show AI scoring animation screen
      showScreen('scoring');

      try {
        await runAIScoring();
      } catch (err) {
        console.error('Scoring error:', err);
      }

      const totalBefore = articles.length;

      // --- TRENDING: Tag articles whose title appears across multiple sources ---
      try {
        const normalize = (t) => (t || '').toLowerCase().replace(/[^a-z0-9 ]/g, '').replace(/\s+/g, ' ').trim();
        for (const a of articles) {
          const norm = normalize(a.title);
          const words = norm.split(' ');
          const sourcesFound = new Set();
          sourcesFound.add(a.source);
          for (const b of articles) {
            if (b.id === a.id) continue;
            const normB = normalize(b.title);
            const wordsB = normB.split(' ');
            const overlap = words.filter(w => wordsB.includes(w)).length;
            if (overlap >= Math.min(words.length, wordsB.length) * 0.6) {
              sourcesFound.add(b.source);
            }
          }
          if (sourcesFound.size >= 2) {
            if (!a.tags) a.tags = [];
            if (!a.tags.includes('Trending')) a.tags.push('Trending');
            a.sourceCount = sourcesFound.size;
          }
        }
      } catch (e) { console.error('Trending tag error:', e); }

      // --- DEDUP: Remove articles with very similar titles ---
      try {
        const normalize = (t) => (t || '').toLowerCase().replace(/[^a-z0-9 ]/g, '').replace(/\s+/g, ' ').trim();
        const seen = [];
        const deduped = [];
        for (const a of articles) {
          const norm = normalize(a.title);
          const isDupe = seen.some(s => {
            if (norm === s) return true;
            const wordsA = norm.split(' ');
            const wordsB = s.split(' ');
            const overlap = wordsA.filter(w => wordsB.includes(w)).length;
            return overlap >= Math.min(wordsA.length, wordsB.length) * 0.85;
          });
          if (!isDupe) {
            seen.push(norm);
            deduped.push(a);
          }
        }
        const dupesRemoved = totalBefore - deduped.length;
        if (dupesRemoved > 0) console.log(`Dedup: removed ${dupesRemoved} duplicate articles`);
        articles = deduped;
      } catch (e) { console.error('Dedup error:', e); }

      // --- GAME CHANGER: Tag articles with high avg scores ---
      try {
        for (const a of articles) {
          const avg = parseFloat(a.avgScore) || 0;
          if (avg >= 88) {
            if (!a.tags) a.tags = [];
            if (!a.tags.includes('Game Changer')) a.tags.push('Game Changer');
          }
        }
      } catch (e) { console.error('Game Changer tag error:', e); }

      // --- FILTER: Remove articles under 40 words ---
      try {
        const beforeFilter = articles.length;
        const filtered = articles.filter(a => (a.words || 0) >= 20);
        if (beforeFilter - filtered.length > 0) console.log(`Filtered out ${beforeFilter - filtered.length} articles under 20 words`);
        articles = filtered.length > 0 ? filtered : articles;
      } catch (e) { console.error('Filter error:', e); }

      // Sort articles by combined score (AI score + user preference learning)
      try {
        articles.sort((a, b) => {
          const relevanceA = calculateRelevanceScore(a) || 0;
          const relevanceB = calculateRelevanceScore(b) || 0;
          const combinedA = (parseFloat(a.avgScore) || 0) + (relevanceA * 5);
          const combinedB = (parseFloat(b.avgScore) || 0) + (relevanceB * 5);
          return combinedB - combinedA;
        });
        console.log('Articles sorted by learning + AI scores');
      } catch (sortErr) {
        console.error('Sort error:', sortErr);
      }

      // Show swipe screen
      const filtered = totalBefore - articles.length;
      console.log(`Transitioning to swipe screen with ${articles.length} articles (from ${totalBefore} raw, ${filtered} filtered)`);
      window._filterInfo = filtered > 0 ? `(${filtered} filtered)` : '';
      showScreen('swipe');
    }

    function goHome() {
      currentCardIndex = 0;
      articles = [];
      showScreen('home');
      // Reset dropdown to blank placeholder
      const dropdown = document.getElementById('topic-dropdown');
      if (dropdown) dropdown.selectedIndex = 0;
      // Hide fetching indicator
      const indicator = document.getElementById('topic-fetching-indicator');
      if (indicator) indicator.classList.remove('visible');
    }

    function abortGeneration() {
      if (generationPollInterval) {
        clearInterval(generationPollInterval);
        generationPollInterval = null;
      }
      resetAudioState();
      const stopBtn = document.getElementById('audio-stop-btn');
      if (stopBtn) stopBtn.style.display = 'none';
      showScreen('swipe');
    }

    // SCREEN NAVIGATION
    // ============================================
    function showScreen(screenId) {
      // Reset audio when leaving generating screen
      const currentScreen = document.querySelector('.screen.active');
      if (currentScreen && currentScreen.id === 'screen-generating' && screenId !== 'generating') {
        resetAudioState();
      }

      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById('screen-' + screenId).classList.add('active');

      if (screenId === 'swipe') {
        renderCards();
      } else if (screenId === 'favorites') {
        renderFavorites();
      } else if (screenId === 'generating') {
        resetAudioState();
      }
    }

    // ============================================
    // STANDALONE PARALLEL FETCH FUNCTIONS
    // ============================================
    function parsePerplexityResponse(data) {
      if (!data.choices?.[0]?.message?.content) return [];
      let content = data.choices[0].message.content;
      content = content.replace(/```(?:json)?\s*/gi, '').replace(/```/g, '').trim();
      const jsonMatch = content.match(/\[[\s\S]*\]/);
      if (jsonMatch) content = jsonMatch[0];
      return JSON.parse(content).map(a => {
        const text = (a.title || '') + ' ' + (a.summary || '');
        return {
          id: Date.now() + Math.random(),
          title: a.title,
          summary: a.summary || '',
          url: a.url,
          image: a.imageUrl || null,
          source: 'perplexity',
          publishedAt: a.publishedAt,
          date: formatDate(a.publishedAt || new Date().toISOString()),
          words: text.split(/\s+/).filter(w => w).length
        };
      });
    }

    function parseGrokResponse(data) {
      if (!data.choices?.[0]?.message?.content) return [];
      let content = data.choices[0].message.content;
      content = content.replace(/```(?:json)?\s*/gi, '').replace(/```/g, '').trim();
      const jsonMatch = content.match(/\[[\s\S]*\]/);
      if (jsonMatch) content = jsonMatch[0];
      return JSON.parse(content).map(a => {
        const text = (a.title || '') + ' ' + (a.summary || '');
        return {
          id: Date.now() + Math.random(),
          title: a.title,
          summary: a.summary || '',
          url: (a.url && a.url !== '#') ? a.url : '',
          source: 'grok',
          publishedAt: a.publishedAt,
          date: formatDate(a.publishedAt || new Date().toISOString()),
          words: text.split(/\s+/).filter(w => w).length
        };
      });
    }

    async function fetchPerplexityBreaking() {
      try {
        const today = new Date().toISOString().split('T')[0];
        const resp = await fetch('/api/perplexity', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'sonar',
            messages: [
              { role: 'system', content: 'You are a news research assistant. Return ONLY valid JSON arrays. Every URL must be a real, verifiable article link.' },
              { role: 'user', content: `Find 15 breaking news articles from the past 7 days (today is ${today}) about "${selectedTopic}". Focus on the most impactful, widely-reported stories with real facts and figures. Return as a JSON array: [{"title":"...","summary":"...","url":"https://...","publishedAt":"YYYY-MM-DD","imageUrl":"..."}]` }
            ]
          }),
          signal: AbortSignal.timeout(15000)
        });
        const data = await resp.json();
        const parsed = parsePerplexityResponse(data);
        parsed.forEach(a => { if (!a.image) a.image = getTopicImage(selectedTopic); });
        articles = [...articles, ...parsed];
        console.log(`Perplexity-breaking: ${parsed.length} articles`);
      } catch (e) { console.error('Perplexity-breaking error:', e.message || e); }
    }

    async function fetchPerplexityAnalysis() {
      try {
        const resp = await fetch('/api/perplexity', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'sonar',
            messages: [
              { role: 'system', content: 'You are an industry research analyst. Return ONLY valid JSON arrays. Every URL must be a real, verifiable article link.' },
              { role: 'user', content: `Find 15 in-depth industry analysis articles, research reports, and expert opinion pieces from the past 30 days about "${selectedTopic}". Focus on strategic insights, market data, and expert commentary - NOT breaking news. Return as a JSON array: [{"title":"...","summary":"...","url":"https://...","publishedAt":"YYYY-MM-DD","imageUrl":"..."}]` }
            ]
          }),
          signal: AbortSignal.timeout(15000)
        });
        const data = await resp.json();
        const parsed = parsePerplexityResponse(data);
        parsed.forEach(a => { if (!a.image) a.image = getTopicImage(selectedTopic); });
        articles = [...articles, ...parsed];
        console.log(`Perplexity-analysis: ${parsed.length} articles`);
      } catch (e) { console.error('Perplexity-analysis error:', e.message || e); }
    }

    async function fetchGrokAnalysis() {
      try {
        const resp = await fetch('/api/grok', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'grok-3-mini',
            messages: [
              { role: 'system', content: 'You are an industry analyst. Return ONLY valid JSON arrays. Focus on analysis and expert opinions. Do NOT fabricate URLs - use "#" for the url field.' },
              { role: 'user', content: `List 15 important developments, expert analyses, or emerging trends in "${selectedTopic}" that professionals should know about. Focus on specific companies, deals, technologies, or policy changes. For each, write a detailed 4-5 sentence analytical summary. Return as a JSON array: [{"title":"...","summary":"...","url":"#","publishedAt":"YYYY-MM-DD"}]` }
            ],
            temperature: 0.7
          }),
          signal: AbortSignal.timeout(55000)
        });
        const data = await resp.json();
        const parsed = parseGrokResponse(data);
        parsed.forEach(a => { if (!a.image) a.image = getTopicImage(selectedTopic); });
        articles = [...articles, ...parsed];
        console.log(`Grok-analysis: ${parsed.length} articles`);
      } catch (e) { console.error('Grok-analysis error:', e.message || e); }
    }

    async function fetchGrokPredictions() {
      try {
        const resp = await fetch('/api/grok', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'grok-3-mini',
            messages: [
              { role: 'system', content: 'You are a forward-looking technology strategist. Return ONLY valid JSON arrays. Do NOT fabricate URLs - use "#" for the url field.' },
              { role: 'user', content: `List 15 bold predictions, contrarian perspectives, and emerging opportunities in "${selectedTopic}" for the next 6-12 months. Include specific company moves, funding rounds, regulatory shifts, and technology breakthroughs that most people are missing. For each, write a 4-5 sentence summary explaining the thesis. Return as a JSON array: [{"title":"...","summary":"...","url":"#","publishedAt":"YYYY-MM-DD"}]` }
            ],
            temperature: 0.9
          }),
          signal: AbortSignal.timeout(55000)
        });
        const data = await resp.json();
        const parsed = parseGrokResponse(data);
        parsed.forEach(a => { if (!a.image) a.image = getTopicImage(selectedTopic); });
        articles = [...articles, ...parsed];
        console.log(`Grok-predictions: ${parsed.length} articles`);
      } catch (e) { console.error('Grok-predictions error:', e.message || e); }
    }

    // ============================================
    // HOME SCREEN - FETCH SOURCES (NewsAPI/NewsData only)
    // ============================================
    async function fetchSource(source) {
      const btn = document.querySelector(`.source-btn[data-source="${source}"]`);
      if (btn) btn.classList.add('fetching');

      // API calls through Vercel serverless routes (no CORS issues)
      try {
        let directArticles = [];

        if (source === 'newsapi') {
          const resp = await fetch(`/api/newsapi?q=${encodeURIComponent(selectedTopic)}&pageSize=25`, { signal: AbortSignal.timeout(10000) });
          const data = await resp.json();
          if (data.articles) {
            directArticles = data.articles.map(a => {
              const text = (a.title || '') + ' ' + (a.description || '') + ' ' + (a.content || '');
              return {
              id: Date.now() + Math.random(),
              title: a.title,
              summary: a.description || '',
              url: a.url,
              image: a.urlToImage,
              source: 'newsapi',
              publishedAt: a.publishedAt,
              date: formatDate(a.publishedAt),
              words: text.split(/\s+/).filter(w => w).length,
            };
            });
          }
        } else if (source === 'newsdata') {
          const resp = await fetch(`/api/newsdata?q=${encodeURIComponent(selectedTopic)}&language=en`, { signal: AbortSignal.timeout(10000) });
          const data = await resp.json();
          // Handle both data.results (v1) and data.data (v2) API formats
          const results = (data.results && Array.isArray(data.results)) ? data.results
            : (data.data && Array.isArray(data.data)) ? data.data
            : [];
          if (results.length > 0) {
            directArticles = results.map(a => {
              const text = (a.title || '') + ' ' + (a.description || '') + ' ' + (a.content || '');
              return {
              id: Date.now() + Math.random(),
              title: a.title,
              summary: a.description || '',
              url: a.link,
              image: a.image_url,
              source: 'newsdata',
              publishedAt: a.pubDate,
              date: formatDate(a.pubDate),
              words: text.split(/\s+/).filter(w => w).length,
            };
            });
          }
        }
        // Perplexity and Grok are now handled by standalone parallel functions

        if (directArticles.length > 0) {
          // Fill in missing images with topic-based placeholders
          directArticles.forEach(a => {
            if (!a.image) a.image = getTopicImage(selectedTopic);
          });
          articles = [...articles, ...directArticles];
          if (btn) {
            btn.classList.remove('fetching');
            btn.classList.add('done');
            btn.querySelector('.count').textContent = directArticles.length;
          }
          console.log(`Got ${directArticles.length} articles directly from ${source}`);
          return directArticles.length;
        }
      } catch (err) {
        console.log(`API call failed for ${source}:`, err);
      }

      // Fallback to demo data
      if (btn) btn.classList.remove('fetching');
      const fakeArticles = generateFakeArticles(source, 5);
      articles = [...articles, ...fakeArticles];
      if (btn) {
        btn.querySelector('.count').textContent = fakeArticles.length;
        btn.classList.add('done');
      }

      return fakeArticles.length;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function clampScore(val) {
      const n = parseInt(val) || 75;
      return Math.max(0, Math.min(100, n));
    }

    // --- Scoring Cache (localStorage) ---
    function getScoringCacheKey(topic) {
      const today = new Date().toISOString().slice(0, 10);
      return `ai-radar-scores-${topic.toLowerCase().replace(/\s+/g, '-')}-${today}`;
    }

    function loadScoringCache(topic) {
      try {
        const key = getScoringCacheKey(topic);
        const cached = localStorage.getItem(key);
        if (!cached) return null;
        const data = JSON.parse(cached);
        // Cache valid for 4 hours
        if (Date.now() - data.timestamp > 4 * 60 * 60 * 1000) {
          localStorage.removeItem(key);
          return null;
        }
        console.log(`Loaded ${data.articles.length} cached scored articles for "${topic}"`);
        return data.articles;
      } catch (e) { return null; }
    }

    function saveScoringCache(topic, scoredArticles) {
      try {
        const key = getScoringCacheKey(topic);
        // Clean old caches (keep only last 5 topics)
        const allKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i);
          if (k && k.startsWith('ai-radar-scores-')) allKeys.push(k);
        }
        if (allKeys.length > 5) {
          allKeys.sort();
          allKeys.slice(0, allKeys.length - 5).forEach(k => localStorage.removeItem(k));
        }
        localStorage.setItem(key, JSON.stringify({
          timestamp: Date.now(),
          articles: scoredArticles.map(a => ({
            title: a.title, source: a.source, url: a.url, date: a.date,
            summary: a.summary, words: a.words, image: a.image, id: a.id,
            scores: a.scores, avgScore: a.avgScore, rationales: a.rationales,
            sentiment: a.sentiment, tags: a.tags
          }))
        }));
        console.log(`Cached ${scoredArticles.length} scored articles for "${topic}"`);
      } catch (e) { console.warn('Cache save failed:', e.message); }
    }

    async function runAIScoring() {
      const aiModels = ['gpt', 'claude', 'gemini', 'grok', 'pplx'];
      const aiNames = { gpt: 'ChatGPT', claude: 'Claude', gemini: 'Gemini', grok: 'Grok', pplx: 'Perplexity' };
      const statusEl = document.getElementById('scoring-status');
      const countEl = document.getElementById('scoring-count');

      if (!statusEl || !countEl) {
        console.error('Scoring elements not found');
        return;
      }

      // Check cache first
      const cached = loadScoringCache(selectedTopic);
      if (cached && cached.length > 0) {
        statusEl.textContent = 'Loading cached scores...';
        countEl.textContent = `${cached.length} articles (cached)`;
        articles = cached;
        // Quick animation - light up all logos
        aiModels.forEach((ai, idx) => {
          setTimeout(() => {
            const el = document.getElementById(`score-${ai}`);
            if (el) { el.style.opacity = '1'; el.style.transform = 'scale(1.1)'; setTimeout(() => el.style.transform = 'scale(1)', 200); }
          }, idx * 150);
        });
        await sleep(800);
        statusEl.textContent = 'Complete! Ranking by AI scores...';
        countEl.textContent = `${articles.length} articles scored`;
        return;
      }

      // Reset all logos to dim
      aiModels.forEach(ai => {
        const el = document.getElementById(`score-${ai}`);
        if (el) el.style.opacity = '0.3';
      });

      statusEl.textContent = 'Preparing articles for AI analysis...';
      countEl.textContent = `0 of ${articles.length} articles scored`;

      // Batch articles (max 25 per call)
      const BATCH_SIZE = 25;
      const batches = [];
      for (let i = 0; i < articles.length; i += BATCH_SIZE) {
        batches.push({ start: i, items: articles.slice(i, i + BATCH_SIZE) });
      }

      // --- Score ALL batches in PARALLEL ---
      const batchPromises = batches.map((batch, batchIdx) => {
        const articleList = batch.items.map((a, i) =>
          `[${i}] "${a.title}" (source: ${a.source}, date: ${a.date || 'unknown'}, ${a.words || 0} words)\nSummary: ${(a.summary || 'No summary').substring(0, 400)}`
        ).join('\n\n');

        const prompt = `You are scoring ${batch.items.length} articles about "${selectedTopic}" from 5 AI perspectives for a professional audience.

Perspectives:
- GPT: writing quality, clarity, breadth of impact, actionability
- Claude: analytical depth, factual rigor, ethical implications, original insight
- Gemini: visual/presentation potential, search trend alignment, audience engagement
- Grok: social virality, community buzz, contrarian or surprising angles
- Perplexity: source credibility, citation quality, recency, cross-source verification

Scoring guidelines:
- 90-100: Exceptional. Would change industry strategy or go viral among professionals.
- 75-89: Strong. Worth sharing on LinkedIn. Clear value for decision-makers.
- 60-74: Average. Informative but not distinctive or urgent.
- Below 60: Weak. Thin content, vague, or outdated.

For each article return: scores (0-100), rationales (20-30 words each explaining the specific reasoning), sentiment (positive/negative/neutral/mixed), and 0-2 tags from [Trending, Hot, Top Article, Breaking, Viral, Must Read, Deep Dive, Game Changer].

Articles:
${articleList}

Return JSON only: {"results":[{"scores":{"gpt":82,"claude":78,"gemini":85,"grok":90,"pplx":80},"rationales":{"gpt":"...","claude":"...","gemini":"...","grok":"...","pplx":"..."},"sentiment":"positive","tags":["Trending"]}]}`;

        return fetch('/api/grok', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'grok-3-mini',
            messages: [{ role: 'user', content: prompt }],
            temperature: 0.3
          }),
          signal: AbortSignal.timeout(45000)
        }).then(r => r.json()).then(data => {
          if (data.choices?.[0]?.message?.content) {
            let content = data.choices[0].message.content;
            content = content.replace(/```(?:json)?\s*/gi, '').replace(/```/g, '').trim();
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (jsonMatch) content = jsonMatch[0];
            const parsed = JSON.parse(content);
            if (parsed.results && Array.isArray(parsed.results)) {
              return { batchIdx, results: parsed.results, count: batch.items.length };
            }
          }
          return { batchIdx, results: [], count: 0 };
        }).catch(err => {
          console.error(`AI Scoring batch ${batchIdx + 1} error:`, err);
          return { batchIdx, results: [], count: 0 };
        });
      });

      // Animate logos while waiting - cycle through them every 2s
      let animInterval = setInterval(() => {
        const nextIdx = Math.floor(Math.random() * aiModels.length);
        const el = document.getElementById(`score-${aiModels[nextIdx]}`);
        if (el) {
          el.style.opacity = '1';
          el.style.transform = 'scale(1.15)';
          setTimeout(() => { el.style.transform = 'scale(1)'; }, 300);
        }
      }, 800);

      statusEl.textContent = `All 5 AI models scoring ${articles.length} articles in parallel...`;

      // Wait for all batches to complete
      const batchResults = await Promise.allSettled(batchPromises);

      clearInterval(animInterval);

      // Merge results in order
      let allResults = [];
      let apiSuccess = false;
      let scoredCount = 0;

      // Sort by batchIdx to maintain article order
      const ordered = batchResults
        .filter(r => r.status === 'fulfilled' && r.value)
        .map(r => r.value)
        .sort((a, b) => a.batchIdx - b.batchIdx);

      for (const batch of ordered) {
        if (batch.results.length > 0) {
          allResults = [...allResults, ...batch.results];
          scoredCount += batch.count;
          apiSuccess = true;
        }
      }

      countEl.textContent = `${scoredCount} of ${articles.length} articles scored`;

      // Merge results into articles
      if (apiSuccess && allResults.length > 0) {
        for (let i = 0; i < articles.length && i < allResults.length; i++) {
          const r = allResults[i];
          if (r && r.scores) {
            articles[i].scores = {
              gpt: clampScore(r.scores.gpt),
              claude: clampScore(r.scores.claude),
              gemini: clampScore(r.scores.gemini),
              grok: clampScore(r.scores.grok),
              pplx: clampScore(r.scores.pplx)
            };
            const s = articles[i].scores;
            articles[i].avgScore = ((s.gpt + s.claude + s.gemini + s.grok + s.pplx) / 5).toFixed(1);
            articles[i].rationales = r.rationales || {};
            articles[i].sentiment = r.sentiment || 'neutral';
            articles[i].tags = Array.isArray(r.tags) ? r.tags : [];
          }
        }
        statusEl.textContent = 'Complete! Ranking by AI scores...';
        console.log('AI scoring complete (real)', allResults.length, 'results');
        // Save to cache
        saveScoringCache(selectedTopic, articles);
      } else {
        // Fallback: random scores (marked as estimates)
        console.log('AI scoring failed, using fallback');
        articles.forEach(a => {
          if (!a.scores) {
            a.scores = {
              gpt: Math.floor(Math.random() * 25) + 70,
              claude: Math.floor(Math.random() * 25) + 70,
              gemini: Math.floor(Math.random() * 25) + 70,
              grok: Math.floor(Math.random() * 25) + 70,
              pplx: Math.floor(Math.random() * 25) + 70
            };
            a.estimatedScores = true;
          }
          const s = a.scores;
          if (!a.avgScore) a.avgScore = ((s.gpt + s.claude + s.gemini + s.grok + s.pplx) / 5).toFixed(1);
          a.sentiment = a.sentiment || 'neutral';
          a.tags = a.tags || [];
        });
        statusEl.textContent = 'Scored with baseline estimates...';
        showToast('AI scoring unavailable - showing estimated scores');
      }

      // Ensure all logos lit
      aiModels.forEach(ai => {
        const el = document.getElementById(`score-${ai}`);
        if (el) {
          el.style.opacity = '1';
          el.style.transform = 'scale(1.1)';
          setTimeout(() => el.style.transform = 'scale(1)', 200);
        }
      });

      countEl.textContent = `${articles.length} articles scored`;
      await sleep(500);
    }

    // Topic-based placeholder images for articles missing images
    function getTopicImage(topic) {
      const topicImages = {
        'artificial intelligence': 'photo-1677442136019-21780ecad995',
        'machine learning': 'photo-1555255707-c07966088b7b',
        'large language models': 'photo-1676299081847-824916de030a',
        'robotics': 'photo-1485827404703-89b55fcc595e',
        'autonomous vehicles': 'photo-1558618666-fcd25c85f82e',
        'quantum computing': 'photo-1635070041078-e363dbe005cb',
        'edge computing': 'photo-1558494949-ef010cbdcc31',
        'startups': 'photo-1559136555-9303baea8ebd',
        'fintech': 'photo-1563013544-824ae1b704d3',
        'cryptocurrency': 'photo-1621761191319-c6fb62004040',
        'stock market': 'photo-1611974789855-9c2a0a7236a3',
        'private equity': 'photo-1454165804606-c3d57bc86b40',
        'mergers and acquisitions': 'photo-1507679799987-c73779587ccf',
        'healthcare ai': 'photo-1576091160399-112ba8d25d1d',
        'climate tech': 'photo-1473341304170-971dccb5ac1e',
        'cybersecurity': 'photo-1550751827-4bd374c3f58b',
        'space technology': 'photo-1446776811953-b23d57bd21aa',
        'manufacturing automation': 'photo-1565043666747-69f6646db940',
        'retail technology': 'photo-1556742049-0cfed4f6a45d',
        'supply chain ai': 'photo-1586528116311-ad8dd3c8310d',
        'proptech': 'photo-1560518883-ce09059eeffa'
      };
      const id = topicImages[topic] || topicImages['artificial intelligence'];
      return `https://images.unsplash.com/${id}?w=400&h=200&fit=crop`;
    }

    function generateFakeArticles(source, count) {
      const articles = [
        {
          title: 'OpenAI Announces GPT-5 Preview for Enterprise Customers',
          summary: 'The next generation language model promises significant improvements in reasoning and code generation capabilities. Early testers report 40% better performance on complex multi-step tasks and near-human level understanding of nuanced instructions.',
          image: 'https://images.unsplash.com/photo-1677442136019-21780ecad995?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Major AI milestone, high engagement expected',
            claude: 'Significant industry impact, well-documented',
            gemini: 'Competitive landscape shift, viral potential',
            grok: 'Trending #1 on tech Twitter right now',
            pplx: 'Confirmed by multiple tier-1 sources'
          }
        },
        {
          title: 'Apple Reveals New AI Features Coming to iOS 19',
          summary: 'Siri gets a major upgrade with on-device LLM processing and new contextual awareness features. The update includes real-time translation, smart summarization, and predictive actions based on user habits.',
          image: 'https://images.unsplash.com/photo-1611532736597-de2d4265fba3?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Mass market appeal, affects billions',
            claude: 'Privacy-focused approach is newsworthy',
            gemini: 'Strong visual content opportunity',
            grok: 'Apple fans highly engaged on this',
            pplx: 'Official Apple announcement verified'
          }
        },
        {
          title: 'Google DeepMind Achieves Breakthrough in Protein Folding',
          summary: 'AlphaFold 3 can now predict protein interactions with unprecedented accuracy, accelerating drug discovery. Researchers say this could cut drug development timelines by years and save billions in R&D costs.',
          image: 'https://images.unsplash.com/photo-1532187863486-abf9dbad1b69?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Scientific breakthrough with real-world impact',
            claude: 'Healthcare implications are profound',
            gemini: 'Google property, have insider context',
            grok: 'Science community buzzing about this',
            pplx: 'Peer-reviewed research backing claims'
          }
        },
        {
          title: 'Microsoft Copilot Now Available in All Office Apps',
          summary: 'AI-powered assistance comes to Word, Excel, PowerPoint and Outlook for all Microsoft 365 subscribers. The rollout marks the largest enterprise AI deployment in history, touching 400M+ users.',
          image: 'https://images.unsplash.com/photo-1633419461186-7d40a38105ec?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Enterprise AI adoption accelerating',
            claude: 'Productivity implications significant',
            gemini: 'Direct competitor move, important',
            grok: 'Business Twitter loves productivity tools',
            pplx: 'Microsoft official blog confirmed'
          }
        },
        {
          title: 'Meta Launches New Open Source LLM for Developers',
          summary: 'Llama 4 offers state-of-the-art performance with full commercial usage rights and no API costs. Benchmarks show it outperforms GPT-4 on coding tasks while being completely free to use.',
          image: 'https://images.unsplash.com/photo-1611162617474-5b21e879e113?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Open source AI is reshaping the industry',
            claude: 'Democratization of AI is key theme',
            gemini: 'Competitive threat assessment needed',
            grok: 'Dev community extremely excited',
            pplx: 'Benchmarks independently verified'
          }
        },
        {
          title: 'NVIDIA Reports Record Revenue from AI Chip Demand',
          summary: 'Data center GPU sales surge 400% as companies race to build AI infrastructure. The company now holds 95% market share in AI training chips, with demand outpacing supply through 2025.',
          image: 'https://images.unsplash.com/photo-1591799264318-7e6ef8ddb7ea?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Infrastructure story underlies all AI',
            claude: 'Market dynamics worth analyzing',
            gemini: 'Financial implications substantial',
            grok: 'Stock traders very engaged on this',
            pplx: 'SEC filings confirm numbers'
          }
        },
        {
          title: 'Amazon AWS Introduces New AI Training Services',
          summary: 'Bedrock platform expands with custom model fine-tuning and new foundation model options. Enterprise customers can now train proprietary models on their own data with full privacy guarantees.',
          image: 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Cloud AI competition heating up',
            claude: 'Enterprise AI needs are evolving',
            gemini: 'Multi-cloud strategy implications',
            grok: 'AWS re:Invent always trends big',
            pplx: 'AWS documentation confirms features'
          }
        },
        {
          title: 'Tesla FSD V13 Achieves Level 4 Autonomy Certification',
          summary: 'Regulatory approval marks milestone for self-driving technology deployment at scale. Tesla vehicles can now operate without human supervision in approved geofenced areas across 12 US states.',
          image: 'https://images.unsplash.com/photo-1560958089-b8a1929cea89?w=400&h=200&fit=crop',
          rationales: {
            gpt: 'Autonomous vehicles reaching inflection',
            claude: 'Safety and regulatory angle important',
            gemini: 'Transportation revolution underway',
            grok: 'Elon content always goes viral',
            pplx: 'NHTSA approval docs verified'
          }
        }
      ];

      const dates = ['Today', 'Yesterday', '2 days ago', 'Jan 10', 'Jan 9', 'Jan 8'];
      const pages = [2, 3, 4, 5, 6, 7];

      return Array.from({length: count}, (_, i) => {
        const article = articles[Math.floor(Math.random() * articles.length)];
        return {
          id: Date.now() + i + Math.random(),
          title: article.title,
          source: source,
          summary: article.summary,
          image: article.image,
          date: dates[Math.floor(Math.random() * dates.length)],
          pages: pages[Math.floor(Math.random() * pages.length)],
          words: Math.floor(Math.random() * 1500) + 500, // 500-2000 words (always >= 500)
          rationales: article.rationales,
          scores: {
            gpt: Math.floor(Math.random() * 25) + 70,
            claude: Math.floor(Math.random() * 25) + 70,
            gemini: Math.floor(Math.random() * 25) + 70,
            grok: Math.floor(Math.random() * 25) + 70,
            pplx: Math.floor(Math.random() * 25) + 70
          }
        };
      });
    }

    // ============================================
    // SWIPE CARDS
    // ============================================
    function renderCards() {
      const stack = document.getElementById('card-stack');
      const remaining = articles.length - currentCardIndex;

      // Update card counter
      const currentNum = currentCardIndex + 1;
      const totalNum = articles.length;
      const filterNote = window._filterInfo || '';
      document.getElementById('swipe-card-counter').innerHTML =
        `Card <span>${Math.min(currentNum, totalNum)}</span> of <span>${totalNum}</span>${filterNote ? ` <span style="font-size:9px;color:var(--text-muted);">${filterNote}</span>` : ''}`;

      // Clear existing cards
      stack.querySelectorAll('.swipe-card').forEach(c => c.remove());

      if (remaining === 0) {
        stack.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
            <div style="font-size: 48px; margin-bottom: 12px;">📭</div>
            <h3 style="color: var(--gold); margin-bottom: 8px;">${totalNum === 0 ? 'No articles found' : 'All done!'}</h3>
            <p style="font-size: 13px; line-height: 1.4;">${totalNum === 0 ? 'Try a different topic or fetch more sources.' : `You've reviewed all ${totalNum} articles.`}</p>
            <button onclick="goHome()" style="margin-top: 16px; background: var(--gold); color: var(--bg-primary); border: none; padding: 10px 24px; border-radius: 20px; font-weight: 600; cursor: pointer;">← Back to Sources</button>
          </div>
        `;
        document.getElementById('swipe-card-counter').innerHTML =
          totalNum === 0 ? '<span>No articles</span>' : `<span>${totalNum}</span> of <span>${totalNum}</span> - Done!`;
        return;
      }

      // Show up to 3 cards
      for (let i = 0; i < Math.min(3, remaining); i++) {
        const article = articles[currentCardIndex + i];
        const card = createCard(article, i);
        stack.appendChild(card);
      }

      // Setup swipe on top card
      setupSwipe(stack.querySelector('.swipe-card'));
    }

    function createCard(article, stackIndex) {
      const card = document.createElement('div');
      card.className = 'swipe-card';
      card.style.zIndex = 10 - stackIndex;
      // More visible stack effect - scale down and offset each card
      card.style.transform = `scale(${1 - stackIndex * 0.06}) translateY(${stackIndex * 15}px)`;
      card.style.opacity = stackIndex === 0 ? '1' : `${1 - stackIndex * 0.15}`;
      card.dataset.id = article.id;

      // Use article image or logo placeholder
      const imageUrl = article.image || 'assets/logo-white.png';
      const isLogoFallback = !article.image;

      // Extract key topics from title/summary
      const titleWords = (article.title + ' ' + article.summary).toUpperCase();
      const topics = topicKeywords.filter(t => titleWords.includes(t.toUpperCase())).slice(0, 3);
      if (topics.length === 0) topics.push('Tech', 'News');

      // Calculate word count from available text
      const articleText = (article.summary || article.description || '');
      const wordCount = article.words || (articleText ? articleText.split(/\s+/).filter(w => w).length : 0);

      // Card position info
      const cardNum = currentCardIndex + stackIndex + 1;
      const totalCards = articles.length;

      // Get individual scores (already 0-100 scale)
      const scores = article.scores || {};
      const gptScore = Math.round(scores.gpt || (Math.floor(Math.random() * 25) + 70));
      const claudeScore = Math.round(scores.claude || (Math.floor(Math.random() * 25) + 70));
      const geminiScore = Math.round(scores.gemini || (Math.floor(Math.random() * 25) + 70));
      const grokScore = Math.round(scores.grok || (Math.floor(Math.random() * 25) + 70));
      const pplxScore = Math.round(scores.pplx || (Math.floor(Math.random() * 25) + 70));

      // Sentiment + Tags
      const sentiment = article.sentiment || 'neutral';
      const sentimentLabel = sentiment.charAt(0).toUpperCase() + sentiment.slice(1);
      const articleTags = article.tags || [];
      const tagClasses = { 'Trending': 'trending', 'Hot': 'hot', 'Top Article': 'top-article', 'Breaking': 'breaking', 'Viral': 'viral', 'Must Read': 'must-read', 'Deep Dive': 'deep-dive', 'Game Changer': 'game-changer' };
      const tagsHtml = articleTags.length > 0
        ? `<div class="article-tags">${articleTags.map(t => `<span class="article-tag ${tagClasses[t] || ''}">${t}</span>`).join('')}</div>`
        : '';

      card.innerHTML = `
        <div class="card-image${isLogoFallback ? ' logo-fallback' : ''}" style="background-image: url('${imageUrl}')">
          <div style="position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.6); color: white; padding: 3px 8px; border-radius: 10px; font-weight: 600; font-size: 10px;">
            ${cardNum}/${totalCards}
          </div>
        </div>
        <div class="card-body">
          <div class="card-source">${escapeHtml(article.source)} <span class="sentiment-badge ${sentiment}">${escapeHtml(sentimentLabel)}</span></div>
          ${tagsHtml}
          <h2 class="card-title">${escapeHtml(article.title)}</h2>
          <p class="card-summary">${escapeHtml((article.summary || '').slice(0, 120))}${(article.summary || '').length > 120 ? '...' : ''}</p>
          <div class="card-topics">
            ${topics.map(t => `<span class="card-topic">${escapeHtml(t)}</span>`).join('')}
          </div>
          <div class="card-meta">
            <span>${article.date || 'Today'}</span>
            <span style="font-weight: 700; color: ${wordCount >= 150 ? '#22c55e' : wordCount >= 80 ? '#eab308' : '#ef4444'};">${wordCount}w · ~${Math.max(4, Math.round(wordCount / 80))} slides</span>
          </div>
          <div class="ai-scores-section">
            <div style="text-align: center; margin-bottom: 6px;">
              <span style="font-size: 18px; font-weight: 700; color: var(--gold);">${Math.round((gptScore + claudeScore + geminiScore + grokScore + pplxScore) / 5)}%</span>
              <span style="font-size: 10px; color: #888; margin-left: 4px;">avg${article.estimatedScores ? ' (est.)' : ''}</span>
            </div>
            <div style="display: flex; justify-content: space-around; gap: 4px;">
              <div class="ai-score-item" data-ai="gpt" data-score="${gptScore}" data-article-id="${article.id}" style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                <img src="logos/chatgpt.png" style="width:20px;height:20px;border-radius:50%;">
                <span style="font-size: 10px; font-weight: 600; color: #333; margin-top: 2px;">${gptScore}</span>
              </div>
              <div class="ai-score-item" data-ai="claude" data-score="${claudeScore}" data-article-id="${article.id}" style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                <img src="logos/claude.png" style="width:20px;height:20px;border-radius:50%;">
                <span style="font-size: 10px; font-weight: 600; color: #333; margin-top: 2px;">${claudeScore}</span>
              </div>
              <div class="ai-score-item" data-ai="gemini" data-score="${geminiScore}" data-article-id="${article.id}" style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                <img src="logos/gemini.png" style="width:20px;height:20px;border-radius:50%;">
                <span style="font-size: 10px; font-weight: 600; color: #333; margin-top: 2px;">${geminiScore}</span>
              </div>
              <div class="ai-score-item" data-ai="grok" data-score="${grokScore}" data-article-id="${article.id}" style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                <img src="logos/grok.png" style="width:20px;height:20px;border-radius:50%;background:#333;">
                <span style="font-size: 10px; font-weight: 600; color: #333; margin-top: 2px;">${grokScore}</span>
              </div>
              <div class="ai-score-item" data-ai="pplx" data-score="${pplxScore}" data-article-id="${article.id}" style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                <img src="logos/perplexity.png" style="width:20px;height:20px;border-radius:50%;background:#fff;">
                <span style="font-size: 10px; font-weight: 600; color: #333; margin-top: 2px;">${pplxScore}</span>
              </div>
            </div>
          </div>
        </div>
      `;

      // Add double-click handlers for individual AI scores
      card.querySelectorAll('.ai-score-item').forEach(item => {
        item.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          const ai = item.dataset.ai;
          const score = item.dataset.score;
          const articleId = item.dataset.articleId;
          showAIScoreDetail(ai, score, articleId, article);
        });
      });

      return card;
    }

    // Show AI score detail popup
    function showAIScoreDetail(ai, score, articleId, article) {
      const aiNames = {
        gpt: 'ChatGPT',
        claude: 'Claude',
        gemini: 'Gemini',
        grok: 'Grok',
        pplx: 'Perplexity'
      };
      const rationales = article.rationales || {};
      const rationale = rationales[ai] || `${aiNames[ai]} scored this article ${score}% based on relevance, timeliness, and industry impact.`;

      // Create popup
      const popup = document.createElement('div');
      popup.className = 'ai-detail-popup';
      popup.innerHTML = `
        <div class="ai-detail-content">
          <div class="ai-detail-header">
            <img src="logos/${ai === 'pplx' ? 'perplexity' : ai}.png" style="width: 40px; height: 40px; border-radius: 50%; ${ai === 'grok' ? 'background:#333;' : ai === 'pplx' ? 'background:#fff;' : ''}">
            <div>
              <h3 style="margin: 0; color: var(--gold);">${aiNames[ai]}</h3>
              <span style="font-size: 24px; font-weight: 700;">${score}%</span>
            </div>
          </div>
          <p class="ai-detail-rationale">${rationale}</p>
          <button class="ai-detail-close" onclick="this.closest('.ai-detail-popup').remove()">Close</button>
        </div>
      `;
      document.body.appendChild(popup);
    }

    // Track document-level mouse handlers so we can clean them up
    let _swipeMouseMoveHandler = null;
    let _swipeMouseUpHandler = null;

    function setupSwipe(card) {
      if (!card) return;

      // Remove previous document-level mouse handlers to prevent leak
      if (_swipeMouseMoveHandler) {
        document.removeEventListener('mousemove', _swipeMouseMoveHandler);
      }
      if (_swipeMouseUpHandler) {
        document.removeEventListener('mouseup', _swipeMouseUpHandler);
      }

      let startX = 0, startY = 0;
      let currentX = 0, currentY = 0;
      let isDragging = false;

      card.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        isDragging = true;
        card.classList.add('dragging');
      });

      card.addEventListener('touchmove', (e) => {
        if (!isDragging) return;

        currentX = e.touches[0].clientX - startX;
        currentY = e.touches[0].clientY - startY;

        const rotation = currentX * 0.1;
        card.style.transform = `translate(${currentX}px, ${currentY}px) rotate(${rotation}deg)`;

        // Show indicators
        const threshold = 50;
        document.querySelector('.swipe-indicator.left').style.opacity = currentX < -threshold ? 1 : 0;
        document.querySelector('.swipe-indicator.right').style.opacity = currentX > threshold ? 1 : 0;
        document.querySelector('.swipe-indicator.up').style.opacity = currentY < -threshold ? 1 : 0;
        document.querySelector('.swipe-indicator.down').style.opacity = currentY > threshold ? 1 : 0;
      });

      card.addEventListener('touchend', () => {
        if (!isDragging) return;
        isDragging = false;
        card.classList.remove('dragging');

        // Hide indicators
        document.querySelectorAll('.swipe-indicator').forEach(i => i.style.opacity = 0);

        const threshold = 100;
        const absX = Math.abs(currentX);
        const absY = Math.abs(currentY);

        if (absX > threshold || absY > threshold) {
          if (absX > absY) {
            // Horizontal swipe
            if (currentX > 0) {
              handleSwipe('right', card);
            } else {
              handleSwipe('left', card);
            }
          } else {
            // Vertical swipe
            if (currentY < 0) {
              handleSwipe('up', card);
            } else {
              handleSwipe('down', card);
            }
          }
        } else {
          // Check if it was a tap (minimal movement)
          if (absX < 10 && absY < 10) {
            const articleId = parseFloat(card.dataset.id);
            const article = articles.find(a => a.id === articleId);
            if (article) {
              showArticleModal(article);
            }
          }
          // Reset position
          card.style.transform = '';
        }

        currentX = 0;
        currentY = 0;
      });

      // Mouse support for desktop
      card.addEventListener('mousedown', (e) => {
        startX = e.clientX;
        startY = e.clientY;
        isDragging = true;
        card.classList.add('dragging');
      });

      _swipeMouseMoveHandler = (e) => {
        if (!isDragging) return;

        currentX = e.clientX - startX;
        currentY = e.clientY - startY;

        const rotation = currentX * 0.1;
        card.style.transform = `translate(${currentX}px, ${currentY}px) rotate(${rotation}deg)`;
      };
      document.addEventListener('mousemove', _swipeMouseMoveHandler);

      _swipeMouseUpHandler = () => {
        if (!isDragging) return;
        isDragging = false;
        card.classList.remove('dragging');

        const threshold = 100;
        const absX = Math.abs(currentX);
        const absY = Math.abs(currentY);

        if (absX > threshold || absY > threshold) {
          if (absX > absY) {
            if (currentX > 0) handleSwipe('right', card);
            else handleSwipe('left', card);
          } else {
            if (currentY < 0) handleSwipe('up', card);
            else handleSwipe('down', card);
          }
        } else {
          // Check if it was a click (minimal movement)
          if (absX < 10 && absY < 10) {
            const articleId = parseFloat(card.dataset.id);
            const article = articles.find(a => a.id === articleId);
            if (article) {
              showArticleModal(article);
            }
          }
          card.style.transform = '';
        }

        currentX = 0;
        currentY = 0;
      };
      document.addEventListener('mouseup', _swipeMouseUpHandler);
    }

    function handleSwipe(direction, card) {
      const articleId = parseFloat(card.dataset.id);
      const article = articles.find(a => a.id === articleId);

      // Animate card out
      let exitX = 0, exitY = 0;
      switch(direction) {
        case 'right':
          // CREATE - Auto-generate slides (always medium) & record positive feedback
          selectedArticle = article;
          recordInterested(article);
          // Animate card upward then start generation
          card.style.transition = 'transform 0.3s ease';
          card.style.transform = `translateY(-${window.innerHeight}px)`;
          setTimeout(() => {
            currentCardIndex++;
            startCardGeneration('medium');
          }, 300);
          return; // Don't animate out normally
        case 'left':
          exitX = -window.innerWidth;
          showToast('Skipped');
          break;
        case 'up':
          // GO BACK - Return to home/sources screen
          card.style.transform = '';
          goHome();
          return;
        case 'down':
          // BACK - Go to previous card
          card.style.transform = '';
          if (currentCardIndex > 0) {
            currentCardIndex--;
            renderCards();
            showToast('Back');
          }
          return;
      }

      card.style.transition = 'transform 0.3s ease';
      card.style.transform = `translate(${exitX}px, ${exitY}px) rotate(${exitX * 0.05}deg)`;

      setTimeout(() => {
        currentCardIndex++;
        renderCards();
      }, 300);
    }

    // SAVE FOR LATER
    let savedForLater = JSON.parse(localStorage.getItem('ai-radar-saved') || '[]');

    function addToSavedForLater(article) {
      if (!savedForLater.find(s => s.id === article.id)) {
        savedForLater.unshift({
          ...article,
          savedAt: new Date().toISOString()
        });
        localStorage.setItem('ai-radar-saved', JSON.stringify(savedForLater));
        updateSavedCount();
      }
    }

    function updateSavedCount() {
      const countEl = document.getElementById('fav-count');
      if (countEl) countEl.textContent = savedForLater.length;
    }

    // ============================================
    // ARTICLE DETAIL MODAL
    // ============================================
    function showArticleModal(article) {
      const modal = document.getElementById('article-modal');

      // Populate modal
      const imageUrl = article.image || 'assets/logo-white.png';
      const modalImage = document.getElementById('modal-image');
      modalImage.style.backgroundImage = `url('${imageUrl}')`;
      if (!article.image) {
        modalImage.style.backgroundSize = '60px 60px';
        modalImage.style.backgroundRepeat = 'no-repeat';
        modalImage.style.backgroundPosition = 'center';
      } else {
        modalImage.style.backgroundSize = 'cover';
      }
      document.getElementById('modal-source').textContent = article.source;
      document.getElementById('modal-title').textContent = article.title;
      document.getElementById('modal-date').textContent = article.date || 'Today';
      document.getElementById('modal-pages').textContent = `${article.pages || 3} pages`;
      document.getElementById('modal-description').textContent = article.summary;

      // Compute individual scores
      const mGpt = Math.round(article.scores?.gpt || 80);
      const mClaude = Math.round(article.scores?.claude || 80);
      const mGemini = Math.round(article.scores?.gemini || 80);
      const mGrok = Math.round(article.scores?.grok || 80);
      const mPplx = Math.round(article.scores?.pplx || 80);
      const mAvg = Math.round((mGpt + mClaude + mGemini + mGrok + mPplx) / 5);
      document.getElementById('modal-score').textContent = mAvg + '%';

      // Generate AI consensus text - each on its own line (scores as percentages)
      const consensusTexts = [
        `<strong>GPT</strong> (${mGpt}%): ${escapeHtml(article.rationales?.gpt || 'High relevance score')}`,
        `<strong>Claude</strong> (${mClaude}%): ${escapeHtml(article.rationales?.claude || 'Well-sourced content')}`,
        `<strong>Gemini</strong> (${mGemini}%): ${escapeHtml(article.rationales?.gemini || 'Good engagement potential')}`,
        `<strong>Grok</strong> (${mGrok}%): ${escapeHtml(article.rationales?.grok || 'Trending topic')}`,
        `<strong>Perplexity</strong> (${mPplx}%): ${escapeHtml(article.rationales?.pplx || 'Multiple sources verified')}`
      ];
      document.getElementById('modal-consensus').innerHTML = consensusTexts.join('<br>');

      modal.classList.add('show');
    }

    function hideArticleModal() {
      document.getElementById('article-modal').classList.remove('show');
    }

    // ============================================
    // LENGTH MODAL
    // ============================================


    // Gamma Template IDs for different presentation lengths
    const GAMMA_TEMPLATES = {
      short: 'g_u47ie8xrqvrhirk',
      medium: 'g_mcymorivaww6g9a',
      long: 'g_cerf2t2ar1x2nt8'
    };

    // Card configurations for each length
    const CARD_CONFIGS = {
      short: {
        count: 6,
        steps: [
          { icon: '🎯', step: 'Title Card' },
          { icon: '📊', step: 'Key Stats' },
          { icon: '💡', step: 'Main Insight' },
          { icon: '🔍', step: 'Analysis' },
          { icon: '📈', step: 'Impact' },
          { icon: '🎬', step: 'Call to Action' }
        ]
      },
      medium: {
        count: 12,
        steps: [
          { icon: '🎯', step: 'Title Card' },
          { icon: '📰', step: 'News Hook' },
          { icon: '📊', step: 'Key Stats' },
          { icon: '💡', step: 'Main Insight' },
          { icon: '🔍', step: 'Deep Dive' },
          { icon: '🧠', step: 'AI Analysis' },
          { icon: '📈', step: 'Market Impact' },
          { icon: '🏢', step: 'Industry View' },
          { icon: '⚡', step: 'Quick Takes' },
          { icon: '🔮', step: 'Future Outlook' },
          { icon: '💼', step: 'Action Items' },
          { icon: '🎬', step: 'Call to Action' }
        ]
      },
      long: {
        count: 20,
        steps: [
          { icon: '🎯', step: 'Title Card' },
          { icon: '📰', step: 'Breaking News' },
          { icon: '📋', step: 'Executive Summary' },
          { icon: '📊', step: 'Key Statistics' },
          { icon: '💡', step: 'Core Insight' },
          { icon: '🔍', step: 'Deep Analysis' },
          { icon: '🧠', step: 'AI Perspective' },
          { icon: '📈', step: 'Market Trends' },
          { icon: '🏢', step: 'Industry Impact' },
          { icon: '🌐', step: 'Global Context' },
          { icon: '⚡', step: 'Quick Facts' },
          { icon: '👥', step: 'Stakeholders' },
          { icon: '💰', step: 'Financial View' },
          { icon: '🔮', step: 'Predictions' },
          { icon: '⚠️', step: 'Risks & Challenges' },
          { icon: '🎯', step: 'Opportunities' },
          { icon: '📝', step: 'Expert Quotes' },
          { icon: '💼', step: 'Action Items' },
          { icon: '📚', step: 'Resources' },
          { icon: '🎬', step: 'Call to Action' }
        ]
      }
    };

    // AI Commentary messages for different stages
    const AI_COMMENTARY = [
      "Analyzing the article structure and identifying key points...",
      "Extracting the most impactful statistics and data...",
      "Crafting compelling visual narratives...",
      "Optimizing content for maximum engagement...",
      "Applying your brand template styling...",
      "Generating professional slide layouts...",
      "Fine-tuning typography and spacing...",
      "Adding visual hierarchy and emphasis...",
      "Reviewing for maximum professional impact...",
      "Almost there! Finalizing your carousel..."
    ];

    let currentJobId = null;
    let generationPollInterval = null;

    async function startCardGeneration(length) {
      const config = CARD_CONFIGS[length];
      console.log('Starting generation with config:', length, config);

      // Reset phases and show generating screen
      resetGeneratingPhases();
      showScreen('generating');

      // Set article title in phase 1
      const titleEl = document.getElementById('gen-article-title');
      if (titleEl) titleEl.textContent = selectedArticle?.title || '';

      // Fire TTS audio generation immediately (don't await)
      if (selectedArticle) {
        generateAudioSummaryPhased(selectedArticle);
      }

      // Fire backend generation (don't await)
      const backendPromise = triggerBackendGeneration(length);

      // Dynamic phase 1: min 3s, transition as soon as backend responds (or max 10s)
      const phase1Start = Date.now();
      let phase2Triggered = false;

      const tryTransition = () => {
        if (phase2Triggered) return;
        phase2Triggered = true;
        transitionToPhase2(config.count, backendPromise);
      };

      // When backend responds, transition after minimum 3s
      backendPromise.then(() => {
        const elapsed = Date.now() - phase1Start;
        const remaining = Math.max(0, 3000 - elapsed);
        setTimeout(tryTransition, remaining);
      });

      // Fallback: always transition by 10s even if backend hasn't responded
      setTimeout(tryTransition, 10000);
    }

    function resetGeneratingPhases() {
      const phase1 = document.getElementById('gen-phase-1');
      const phase2 = document.getElementById('gen-phase-2');
      if (phase1) phase1.style.display = 'flex';
      if (phase2) phase2.classList.remove('active');

      // Reset progress
      const fill = document.getElementById('gen-progress-fill');
      const pct = document.getElementById('gen-percent');
      if (fill) fill.style.width = '0%';
      if (pct) pct.textContent = '0%';

      // Reset audio button to disabled
      const audioBtn = document.getElementById('audio-btn');
      if (audioBtn) {
        audioBtn.disabled = true;
        audioBtn.style.opacity = '0.5';
      }
      const audioText = document.getElementById('audio-text');
      if (audioText) audioText.textContent = 'Preparing Audio...';
      const audioIcon = document.getElementById('audio-icon');
      if (audioIcon) audioIcon.textContent = '🎧';
    }

    async function triggerBackendGeneration(length) {
      // Try Gamma API first, fall back to Railway backend
      try {
        console.log('Calling Gamma API to generate presentation...');
        const config = CARD_CONFIGS[length] || CARD_CONFIGS.medium;
        const response = await fetch('/api/gamma', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: selectedArticle.title,
            summary: selectedArticle.summary || selectedArticle.description || '',
            source: selectedArticle.source || '',
            topic: selectedTopic,
            scores: selectedArticle.scores || {},
            rationales: selectedArticle.rationales || {},
            sentiment: selectedArticle.sentiment || 'neutral',
            tags: selectedArticle.tags || [],
            numCards: config.count
          }),
          signal: AbortSignal.timeout(30000)
        });

        if (response.ok) {
          const data = await response.json();
          if (data.generationId) {
            currentJobId = data.generationId;
            window._gammaMode = true;
            console.log('Gamma generation started:', currentJobId);
            return { success: true, jobId: data.generationId, gamma: true };
          }
        } else {
          const errData = await response.json().catch(() => ({}));
          console.log('Gamma API error:', response.status, errData.error);
        }
      } catch (err) {
        console.log('Gamma API not available:', err.message);
      }

      // Fallback: try Railway backend
      try {
        console.log('Falling back to Railway backend...');
        window._gammaMode = false;
        const response = await fetch(`${API_BASE}/generate-from-newsout`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: selectedArticle.title,
            summary: selectedArticle.summary || selectedArticle.description || '',
            source: selectedArticle.source || '',
            link: selectedArticle.link || selectedArticle.url || '',
            avg_score: parseFloat(selectedArticle.avgScore) || 85,
            scores: selectedArticle.scores || {},
            rationales: selectedArticle.rationales || {},
            sentiment: selectedArticle.sentiment || 'neutral',
            tags: selectedArticle.tags || [],
            topic: selectedTopic,
            preview_only: true
          }),
          signal: AbortSignal.timeout(15000)
        });

        if (response.ok) {
          const data = await response.json();
          currentJobId = data.job_id;
          console.log('Railway backend job started:', currentJobId);
          return { success: true, jobId: data.job_id, gamma: false };
        }
      } catch (err) {
        console.log('Railway backend not available:', err.message);
      }
      return { success: false };
    }

    function transitionToPhase2(cardCount, backendPromise) {
      // Hide phase 1, show phase 2
      const phase1 = document.getElementById('gen-phase-1');
      const phase2 = document.getElementById('gen-phase-2');
      if (phase1) phase1.style.display = 'none';
      if (phase2) phase2.classList.add('active');

      // Auto-play audio if ready
      autoPlayAudioIfReady();

      // Set up step card
      const config = CARD_CONFIGS[Object.keys(CARD_CONFIGS).find(k => CARD_CONFIGS[k].count === cardCount)] || CARD_CONFIGS.medium;
      document.getElementById('step-num').textContent = '1';
      document.getElementById('step-total').textContent = `of ${cardCount}`;
      document.getElementById('gen-step-description').textContent = config.steps[0]?.step || 'Starting...';

      // Check if backend started successfully
      backendPromise.then(result => {
        if (result.success) {
          startGenerationPolling(cardCount);
        } else {
          runGenerationSimulation(cardCount);
        }
      });
    }

    function startGenerationPolling(cardCount) {
      let lastPercent = 0;
      let lastStep = 0;
      const config = CARD_CONFIGS[Object.keys(CARD_CONFIGS).find(k => CARD_CONFIGS[k].count === cardCount)] || CARD_CONFIGS.medium;
      const pollStartTime = Date.now();
      const isGamma = window._gammaMode === true;
      const POLL_TIMEOUT_MS = isGamma ? 120000 : 45000; // Gamma can take longer
      const POLL_INTERVAL_MS = isGamma ? 3000 : 1000; // Poll Gamma less frequently
      let gammaPollCount = 0;

      console.log(`Polling started (${isGamma ? 'Gamma API' : 'Railway'}) for job:`, currentJobId);

      generationPollInterval = setInterval(async () => {
        try {
          // Check for timeout
          if (Date.now() - pollStartTime > POLL_TIMEOUT_MS) {
            clearInterval(generationPollInterval);
            console.warn(`Polling timed out after ${POLL_TIMEOUT_MS / 1000}s, falling back to simulation`);
            document.getElementById('gen-step-description').textContent = 'Generation taking long - using preview mode...';
            showToast('Using preview mode');
            setTimeout(() => {
              runGenerationSimulation(cardCount);
            }, 1000);
            return;
          }

          if (isGamma) {
            // --- GAMMA API POLLING ---
            const response = await fetch(`/api/gamma-status?id=${currentJobId}`);
            const data = await response.json();
            gammaPollCount++;

            // Simulate progress since Gamma only returns pending/completed
            const elapsed = Date.now() - pollStartTime;
            const estimatedPercent = Math.min(Math.round((elapsed / 60000) * 95), 95);
            document.getElementById('gen-progress-fill').style.width = `${estimatedPercent}%`;
            document.getElementById('gen-percent').textContent = `${estimatedPercent}%`;

            // Update step animation
            const currentStep = Math.min(Math.floor((estimatedPercent / 100) * cardCount) + 1, cardCount);
            if (currentStep !== lastStep) {
              updateStepCard(currentStep, cardCount, config);
              lastStep = currentStep;
            }

            if (data.status === 'completed' && data.gammaUrl) {
              clearInterval(generationPollInterval);
              document.getElementById('gen-progress-fill').style.width = '100%';
              document.getElementById('gen-percent').textContent = '100%';
              document.getElementById('gen-step-description').textContent = 'Presentation ready!';
              console.log('Gamma generation complete! URL:', data.gammaUrl);

              setTimeout(() => {
                showResultsScreen({
                  status: 'completed',
                  gamma_url: data.gammaUrl,
                  slides: []
                }, false);
              }, 1000);
            } else if (data.status === 'error' || data.status === 'failed') {
              clearInterval(generationPollInterval);
              console.log('Gamma generation failed:', data);
              document.getElementById('gen-step-description').textContent = 'Using preview mode...';
              setTimeout(() => runGenerationSimulation(cardCount), 1000);
            }
            // else still pending, keep polling

          } else {
            // --- RAILWAY BACKEND POLLING ---
            const response = await fetch(`${API_BASE}/status/${currentJobId}`);
            const status = await response.json();

            const percent = status.percent || 0;
            document.getElementById('gen-progress-fill').style.width = `${percent}%`;
            document.getElementById('gen-percent').textContent = `${percent}%`;

            const currentStep = Math.min(Math.floor((percent / 100) * cardCount) + 1, cardCount);
            if (currentStep !== lastStep) {
              updateStepCard(currentStep, cardCount, config);
              lastStep = currentStep;
            }

            lastPercent = percent;

            if (status.status === 'complete' || status.status === 'completed' || status.status === 'posted' || status.status === 'ready_for_review') {
              clearInterval(generationPollInterval);
              const isPreview = status.status === 'ready_for_review';
              document.getElementById('gen-step-description').textContent = isPreview ? 'Ready for review!' : 'Complete!';
              console.log('Generation complete! Slides:', status.slides?.length || 0, 'Preview:', isPreview);

              setTimeout(() => {
                showResultsScreen(status, isPreview);
              }, 1000);
            } else if (status.status === 'error' || status.status === 'failed') {
              clearInterval(generationPollInterval);
              document.getElementById('gen-step-description').textContent = 'Error - using preview mode...';
              showToast('Using preview mode');
              setTimeout(() => runGenerationSimulation(cardCount), 1000);
            }
          }

        } catch (error) {
          console.error('Polling error:', error);
        }
      }, POLL_INTERVAL_MS);
    }

    function updateStepCard(step, total, config) {
      const stepNumEl = document.getElementById('step-num');
      const stepDescEl = document.getElementById('gen-step-description');

      // Animate the number change
      stepNumEl.style.transform = 'scale(1.2)';
      stepNumEl.textContent = step;

      setTimeout(() => {
        stepNumEl.style.transform = 'scale(1)';
      }, 150);

      // Animate description change
      const stepInfo = config.steps[step - 1];
      if (stepInfo) {
        stepDescEl.style.opacity = '0';
        setTimeout(() => {
          stepDescEl.textContent = stepInfo.step;
          stepDescEl.style.opacity = '1';
        }, 100);
      }
    }

    function runGenerationSimulation(cardCount) {
      console.log('Simulation starting for', cardCount, 'cards');
      let lastStep = 0;

      // Find config by count
      let config = CARD_CONFIGS.medium;
      if (cardCount === 6) config = CARD_CONFIGS.short;
      else if (cardCount === 20) config = CARD_CONFIGS.long;

      console.log('Using config:', config);

      // Smooth easing curve over ~35 seconds: fast to 75%, slow to 95%, then complete
      const TOTAL_DURATION = 35000;
      const startTime = Date.now();

      const interval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const t = Math.min(elapsed / TOTAL_DURATION, 1);

        // Easing: fast start, slow middle, quick finish
        // 0-0.6t → 0-75%, 0.6-0.9t → 75-95%, 0.9-1.0t → 95-100%
        let percent;
        if (t < 0.6) {
          percent = (t / 0.6) * 75;
        } else if (t < 0.9) {
          percent = 75 + ((t - 0.6) / 0.3) * 20;
        } else {
          percent = 95 + ((t - 0.9) / 0.1) * 5;
        }
        percent = Math.min(Math.round(percent), 100);

        // Update progress bar
        const progressFill = document.getElementById('gen-progress-fill');
        const percentText = document.getElementById('gen-percent');
        if (progressFill) progressFill.style.width = `${percent}%`;
        if (percentText) percentText.textContent = `${percent}%`;

        // Update single card step
        const currentStep = Math.min(Math.floor((percent / 100) * cardCount) + 1, cardCount);
        if (currentStep !== lastStep) {
          console.log('Step:', currentStep, 'of', cardCount);
          updateStepCard(currentStep, cardCount, config);
          lastStep = currentStep;
        }

        // Complete
        if (percent >= 100) {
          console.log('Simulation complete!');
          clearInterval(interval);
          const descEl = document.getElementById('gen-step-description');
          if (descEl) descEl.textContent = 'Complete!';

          setTimeout(() => {
            showResultsScreen({ status: 'complete' });
          }, 500);
        }
      }, 500);
    }

    // ============================================
    // SAVED ARTICLES
    // ============================================
    function renderFavorites() {
      const list = document.getElementById('favorites-list');

      if (savedForLater.length === 0) {
        list.innerHTML = `
          <div class="favorites-empty">
            <div class="icon">📌</div>
            <p>No saved articles yet.<br>Swipe down on articles to save them!</p>
          </div>
        `;
        return;
      }

      list.innerHTML = savedForLater.map(article => {
        // Extract topics
        const titleWords = (article.title + ' ' + (article.summary || '')).toUpperCase();
        const topics = topicKeywords.filter(t => titleWords.includes(t.toUpperCase())).slice(0, 3);
        if (topics.length === 0) topics.push('Tech', 'News');

        const artText = (article.summary || article.description || '');
        const wordCount = article.words || (artText ? artText.split(/\s+/).filter(w => w).length : 0);
        const s = article.scores || {};
        const avgScore = Math.round(((s.gpt || 80) + (s.claude || 80) + (s.gemini || 80) + (s.grok || 80) + (s.pplx || 80)) / 5);
        const summary = article.summary || 'No description available.';

        return `
          <div class="favorite-item" data-id="${article.id}" onclick="toggleFavExpand(this)">
            <button class="delete-x" onclick="event.stopPropagation(); deleteSavedArticle(${article.id})">×</button>
            <div class="fav-source">${escapeHtml(article.source)}</div>
            <div class="fav-title">${escapeHtml(article.title)}</div>
            <div class="fav-topics">
              ${topics.map(t => `<span class="fav-topic">${escapeHtml(t)}</span>`).join('')}
            </div>
            <div class="fav-meta">
              <span>${escapeHtml(article.date || 'Today')}</span>
              <span style="font-weight: 700; color: ${wordCount >= 150 ? '#22c55e' : wordCount >= 80 ? '#eab308' : '#ef4444'};">${wordCount}w</span>
            </div>
            <div class="fav-scores">
              <span class="fav-avg">${avgScore}%</span>
              <div class="fav-logos">
                <img src="logos/chatgpt.png">
                <img src="logos/claude.png">
                <img src="logos/gemini.png">
                <img src="logos/grok.png" style="background:#333;">
                <img src="logos/perplexity.png" style="background:#fff;">
              </div>
            </div>
            <div class="fav-expanded" style="display: none;">
              <div class="fav-description">${escapeHtml(summary)}</div>
              <button class="fav-create-btn" onclick="event.stopPropagation(); postFavorite(${article.id})">Create Carousel</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleFavExpand(el) {
      const expanded = el.querySelector('.fav-expanded');
      const isVisible = expanded.style.display !== 'none';

      // Close all others first
      document.querySelectorAll('.fav-expanded').forEach(e => e.style.display = 'none');

      // Toggle this one
      expanded.style.display = isVisible ? 'none' : 'block';
    }

    function postFavorite(id) {
      const article = savedForLater.find(f => f.id === id);
      if (article) {
        selectedArticle = article;
        startCardGeneration('medium');
      }
    }

    function deleteSavedArticle(id) {
      savedForLater = savedForLater.filter(a => a.id !== id);
      localStorage.setItem('ai-radar-saved', JSON.stringify(savedForLater));
      updateSavedCount();
      renderFavorites();
      showToast('Removed');
    }

    function clearAllSaved() {
      if (savedForLater.length === 0) return;
      if (confirm('Clear all saved articles?')) {
        savedForLater = [];
        localStorage.setItem('ai-radar-saved', JSON.stringify(savedForLater));
        updateSavedCount();
        renderFavorites();
        showToast('All cleared');
      }
    }

    // ============================================
    // UTILITIES
    // ============================================
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('show', show);
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ============================================
    // FLIPBOOK
    // ============================================
    let currentSlide = 0;
    let totalSlides = 5;
    let generatedSlides = [];

    let _flipbookInitialized = false;
    function initFlipbook() {
      const flipbook = document.getElementById('flipbook');
      if (!flipbook) return;

      // Prevent duplicate listeners on re-init
      if (_flipbookInitialized) return;
      _flipbookInitialized = true;

      let startX = 0;
      let isDragging = false;

      // Touch events
      flipbook.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
      });

      flipbook.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        isDragging = false;

        const diff = e.changedTouches[0].clientX - startX;
        if (Math.abs(diff) > 50) {
          if (diff > 0) {
            flipPrev();
          } else {
            flipNext();
          }
        }
      });

      // Mouse events for desktop
      flipbook.addEventListener('mousedown', (e) => {
        startX = e.clientX;
        isDragging = true;
      });

      flipbook.addEventListener('mouseup', (e) => {
        if (!isDragging) return;
        isDragging = false;

        const diff = e.clientX - startX;
        if (Math.abs(diff) > 50) {
          if (diff > 0) {
            flipPrev();
          } else {
            flipNext();
          }
        }
      });

      // Click on slide to advance
      flipbook.addEventListener('click', () => {
        flipNext();
      });
    }

    function flipNext() {
      if (currentSlide < totalSlides - 1) {
        goToSlide(currentSlide + 1);
      }
    }

    function flipPrev() {
      if (currentSlide > 0) {
        goToSlide(currentSlide - 1);
      }
    }

    function goToSlide(index) {
      const slides = document.querySelectorAll('.flip-slide');
      const dots = document.querySelectorAll('.flip-dot');

      slides[currentSlide].classList.remove('active');
      slides[currentSlide].classList.add('prev');

      currentSlide = index;

      slides.forEach((slide, i) => {
        slide.classList.remove('active', 'prev');
        if (i === currentSlide) {
          slide.classList.add('active');
        } else if (i < currentSlide) {
          slide.classList.add('prev');
        }
      });

      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === currentSlide);
      });
    }

    function populateSlides(article, length, backendSlides = null) {
      // Use backend slides if available, otherwise use placeholders
      let slideData;
      if (backendSlides && backendSlides.length > 0) {
        console.log('Populating with', backendSlides.length, 'backend slides');
        slideData = backendSlides.map((s, i) => {
          // Use content from backend if available
          let body = '';
          if (s.content) {
            body = s.content;
          } else if (s.text) {
            body = s.text;
          } else if (s.status === 'complete') {
            body = '✓ Generated by Gamma AI';
          } else {
            body = 'Processing...';
          }
          return {
            title: s.name || s.title || `Slide ${i + 1}`,
            body: body
          };
        });
      } else {
        console.log('Using placeholder slides');
        // Fallback placeholders
        slideData = [
          { title: article.title, body: '' },
          { title: 'Key Insight', body: 'The main takeaway...' },
          { title: 'Why It Matters', body: 'Industry implications...' },
          { title: 'The Data', body: 'Key statistics...' },
          { title: 'What\'s Next', body: 'Future outlook...' },
          { title: 'Expert View', body: 'Analysis...' },
          { title: 'Market Impact', body: 'Industry effect...' },
          { title: 'Challenges', body: 'Obstacles...' },
          { title: 'Opportunities', body: 'Potential...' },
          { title: 'Action Items', body: 'Next steps...' },
          { title: 'Summary', body: 'Key points...' },
          { title: 'Follow for More', body: 'AI insights daily!' }
        ];
      }

      totalSlides = slideData.length;

      const flipbook = document.getElementById('flipbook');
      const dotsContainer = document.getElementById('flip-dots');

      // Generate slides HTML
      flipbook.innerHTML = slideData.map((slide, i) => `
        <div class="flip-slide ${i === 0 ? 'active' : ''}" data-slide="${i + 1}">
          <div class="slide-content">
            <div class="slide-number">${i + 1}</div>
            <div class="slide-title">${escapeHtml(slide.title)}</div>
            ${slide.body ? `<div class="slide-body">${escapeHtml(slide.body)}</div>` : ''}
          </div>
        </div>
      `).join('');

      // Generate dots
      dotsContainer.innerHTML = slideData.map((_, i) => `
        <span class="flip-dot ${i === 0 ? 'active' : ''}" data-index="${i}" onclick="goToSlide(${i})"></span>
      `).join('');

      currentSlide = 0;
    }

    // Store backend result for results screen
    let lastGenerationResult = null;
    let isPreviewMode = false;

    function showResultsScreen(status = {}, isPreview = false) {
      // Store the result and preview state
      lastGenerationResult = status;
      isPreviewMode = isPreview;

      // Extract result data (backend nests it under 'result')
      const result = status.result || status;
      const slides = status.slides || [];

      // Update Post button based on preview mode
      const postBtn = document.querySelector('.action-btn.primary');
      if (postBtn) {
        postBtn.innerHTML = isPreview
          ? '<i class="fas fa-paper-plane"></i> Post Now'
          : '<i class="fas fa-check"></i> Posted!';
      }

      // Populate slides with backend data
      populateSlides(selectedArticle, selectedLength, slides);

      // Populate source info with logo
      const sourceType = selectedArticle.sourceType || selectedArticle.source?.toLowerCase() || 'newsapi';
      const sourceLogos = {
        'newsapi': 'assets/newsapi.png',
        'newsdata': 'assets/newsdata.png',
        'perplexity': 'assets/perplexity.png',
        'grok': 'logos/grok.png'
      };
      const sourceNames = {
        'newsapi': 'NewsAPI',
        'newsdata': 'NewsData',
        'perplexity': 'Perplexity',
        'grok': 'Grok'
      };

      document.getElementById('results-source-logo').src = sourceLogos[sourceType] || sourceLogos['newsapi'];
      document.getElementById('results-source-name').textContent = sourceNames[sourceType] || selectedArticle.source || 'Unknown Source';
      document.getElementById('results-article-title').textContent = selectedArticle.title || 'Untitled Article';

      // Set link URLs from backend result
      // Gamma URL
      let gammaUrl = result.gamma_url || status.gamma_url || '';
      document.getElementById('gamma-link').href = gammaUrl || 'https://gamma.app';

      // Embed Gamma presentation if we have a URL
      const embedContainer = document.getElementById('gamma-embed-container');
      const flipbookContainer = document.getElementById('flipbook-container');
      const gammaEmbed = document.getElementById('gamma-embed');

      if (gammaUrl && gammaUrl.includes('gamma.app/docs/')) {
        // Extract doc ID and create embed URL
        const docId = gammaUrl.split('/docs/')[1]?.split('?')[0];
        if (docId) {
          const embedUrl = `https://gamma.app/embed/${docId}`;
          console.log('Embedding Gamma:', embedUrl);
          gammaEmbed.src = embedUrl;
          embedContainer.style.display = 'block';
          flipbookContainer.style.display = 'none';
        }
      } else {
        // Fallback to flipbook
        embedContainer.style.display = 'none';
        flipbookContainer.style.display = 'block';
        populateSlides(selectedArticle, selectedLength, slides);
      }

      // Download/PDF link
      let pdfUrl = result.pdf_url || selectedArticle.link || '#';
      document.getElementById('download-link').href = pdfUrl;

      console.log('Results:', { gammaUrl, pdfUrl, slides: slides.length });

      // Set Gamma URL on success modal button
      if (gammaUrl) {
        const viewBtn = document.querySelector('.view-post-btn');
        if (viewBtn) viewBtn.href = gammaUrl;
      }

      showScreen('results');
      initFlipbook();

      // Hide LinkedIn button initially, reveal after slides confirmed
      const linkedinContainer = document.getElementById('linkedin-share-container');
      if (linkedinContainer) {
        linkedinContainer.classList.add('hidden');
        linkedinContainer.classList.remove('reveal');
        // Reveal after delay (500ms for real Gamma, 2s for simulation)
        const delay = gammaUrl ? 500 : 2000;
        setTimeout(() => {
          linkedinContainer.classList.remove('hidden');
          linkedinContainer.classList.add('reveal');
        }, delay);
      }
    }

    function showSuccessModal(gammaUrl = '') {
      const modal = document.getElementById('success-modal');
      const viewBtn = modal.querySelector('.view-post-btn');
      if (gammaUrl) viewBtn.href = gammaUrl;
      modal.classList.add('show');
    }

    function hideSuccessModal() {
      const modal = document.getElementById('success-modal');
      modal.classList.remove('show');
    }

    function shareOnLinkedIn() {
      const gammaLink = document.getElementById('gamma-link');
      const gammaUrl = gammaLink && gammaLink.href && gammaLink.href !== '#'
        ? gammaLink.href
        : '';

      const title = selectedArticle?.title || 'AI Insights';
      const summary = (selectedArticle?.summary || selectedArticle?.description || '').slice(0, 200);

      // Build topic hashtag from selectedTopic
      const topicTag = selectedTopic
        .split(/\s+/)
        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
        .join('');

      let postText = `📊 ${title}\n\n${summary}`;
      if (gammaUrl) postText += `\n\n🔗 View the full presentation: ${gammaUrl}`;
      postText += `\n\nCreated with AI Radar by JJ Shay | jjshay.com`;
      postText += `\n#AI #${topicTag} #Leadership`;

      const linkedinUrl = `https://www.linkedin.com/feed/?shareActive=true&text=${encodeURIComponent(postText)}`;
      window.open(linkedinUrl, '_blank');

      // Show "Posted to LinkedIn!" toast when user returns
      const handleReturn = () => {
        showToast('Posted to LinkedIn!');
        document.removeEventListener('visibilitychange', onVisChange);
        window.removeEventListener('focus', handleReturn);
      };
      const onVisChange = () => {
        if (document.visibilityState === 'visible') handleReturn();
      };
      document.addEventListener('visibilitychange', onVisChange);
      window.addEventListener('focus', handleReturn);
    }

    function skipAndNext() {
      currentCardIndex++;
      showScreen('swipe');
      renderCards();
    }

    function resetAndGoHome() {
      hideSuccessModal();
      currentCardIndex++;
      selectedArticle = null;
      showScreen('swipe');
      renderCards();
    }

    // ============================================
    // INIT
    // ============================================
    updateSavedCount();

    // Show intro on first visit, otherwise go to home
    checkAndShowIntro();
  </script>
</body>
</html>
